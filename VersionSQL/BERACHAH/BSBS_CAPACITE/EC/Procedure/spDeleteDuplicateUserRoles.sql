/****** Object:  Procedure [EC].[spDeleteDuplicateUserRoles]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE [EC].[spDeleteDuplicateUserRoles]
AS

SELECT LOGINID,PROJECTID,ROLEID,COUNT(*) CNT 
INTO #TEMP0 
FROM EC.PROJECTUSERROLES
GROUP BY LOGINID,PROJECTID,ROLEID 
HAVING COUNT(*)>1

DECLARE @LOGINID VARCHAR(25)
DECLARE @PROJECTID INT
DECLARE @ROLEID INT 
DECLARE @PROJECTUSERID INT 
DECLARE @COUNTS INT 
DECLARE PROJLIST CURSOR FOR SELECT * FROM #TEMP0
OPEN PROJLIST
FETCH NEXT FROM PROJLIST INTO @LOGINID,@PROJECTID,@ROLEID,@COUNTS 
WHILE @@FETCH_STATUS=0
BEGIN
  SELECT TOP 1 @PROJECTUSERID=PROJECTUSERID FROM EC.PROJECTUSERROLES 
  WHERE LOGINID=@LOGINID AND PROJECTID=@PROJECTID AND ROLEID=@ROLEID 
  DELETE FROM EC.PROJECTUSERROLES WHERE PROJECTUSERID=@PROJECTUSERID
   
  FETCH NEXT FROM PROJLIST INTO @LOGINID,@PROJECTID,@ROLEID,@COUNTS
END
CLOSE PROJLIST
DEALLOCATE PROJLIST