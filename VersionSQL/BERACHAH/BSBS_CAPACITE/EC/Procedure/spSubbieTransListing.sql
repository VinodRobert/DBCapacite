/****** Object:  Procedure [EC].[spSubbieTransListing]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE  PROCEDURE [EC].[spSubbieTransListing](@BORGID INT,@YEAR INT,@FROMPERIOD INT, @TOPERIOD INT)
AS
CREATE TABLE #FINAL(PARTYCODE VARCHAR(10),PARTYNAME VARCHAR(50), ORDERNUMBER VARCHAR(25), POSTINGDATE DATETIME,
BILLREF VARCHAR(20),TRANGRP INT,ECCATEGORY VARCHAR(25), ECODE VARCHAR(15), ECNAME VARCHAR(100), QTY DECIMAL(18,2), RATE DECIMAL(18,2), AMOUNT DECIMAL(18,2)) 
 
SELECT CREDNO,ORDERNO,PDATE,TRANSREF,TRANGRP  
INTO #TEMP0
FROM TRANSACTIONS 
WHERE ORGID=@BORGID AND YEAR=@YEAR AND PERIOD BETWEEN @FROMPERIOD AND @TOPERIOD AND LEFT(BATCHREF,3)='SCI' AND LEDGERCODE='1320000   '

SELECT T.*,H.HEADERID
INTO #TEMP1 
FROM #TEMP0 T INNER JOIN EC.SUBBIEHEADER H
ON T.TRANGRP = H.TRANGRP


SELECT T.*,D.ECCATEGORY,D.QTY,D.RATE,(D.RATE*D.QTY) AMOUNT ,D.ACTIVITYCODE
INTO #TEMP2 
FROM #TEMP1 T
INNER JOIN EC.SUBBIEDETAILS D 
ON T.HEADERID = D.HEADERID 


INSERT INTO #FINAL(PARTYCODE,ORDERNUMBER,POSTINGDATE,BILLREF, TRANGRP,ECCATEGORY,ECODE       ,QTY,RATE,AMOUNT )
SELECT             CREDNO,   ORDERNO,    PDATE,      TRANSREF,TRANGRP,ECCATEGORY,ACTIVITYCODE,QTY,RATE,AMOUNT FROM #TEMP2 

UPDATE #FINAL SET PARTYNAME = S.SUBNAME FROM SUBCONTRACTORS S INNER JOIN #FINAL ON #FINAL.PARTYCODE=S.SubNumber
UPDATE #FINAL SET ECNAME = EM.ACTIVITYNAME FROM EC.ENGINEERINGCODEMASTER EM INNER JOIN #FINAL ON #FINAL.ECODE=EM.ACTNUMBER 

 
SELECT * FROM #FINAL 