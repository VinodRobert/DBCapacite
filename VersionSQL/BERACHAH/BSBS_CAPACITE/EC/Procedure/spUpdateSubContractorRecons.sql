/****** Object:  Procedure [EC].[spUpdateSubContractorRecons]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE [EC].[spUpdateSubContractorRecons]
AS
 DECLARE @RECONID VARCHAR(25)
 DECLARE @EXISTING INT 

 SELECT BSBORGID INTO #BORGS FROM EC.PROJECTS 

 UPDATE EC.SUBBIEHEADER 
 SET VALNO=SR.VALNO,CERTNO=SR.CERTNOA,POSTREF=SR.POSTREF FROM SUBCRECONS SR INNER JOIN EC.SUBBIEHEADER ON SR.RECONID=EC.SUBBIEHEADER.RECONID 
 WHERE EC.SUBBIEHEADER.TRANGRP=0 

 
 EXEC  EC.spUpdateTRANGRPSUBBIE



 DECLARE RECONLISTS CURSOR FOR SELECT RECONID FROM SUBCRECONS WHERE ORGID IN (SELECT BSBORGID FROM #BORGS)  AND CODE='PO' 
 OPEN RECONLISTS
 FETCH NEXT FROM RECONLISTS INTO @RECONID 
 WHILE @@FETCH_STATUS=0
 BEGIN
   
	-- EXEC [EC].[spFixEngineeringCodesSubbiee] @RECONID 
	
	SET @EXISTING = -1 

	SELECT @EXISTING = ISNULL( COUNT(*) ,0) FROM ATTRIBVALUE WHERE COLKEY = @RECONID
	IF @EXISTING = 0 
	 BEGIN
	   INSERT INTO ATTRIBVALUE(COLKEY,TABLENAME,ATTRIBUTE,VALUE,USERID,LOGDATETIME,ARRAYINDEX)
	   VALUES (@RECONID,'SUBCRECONS','EC','Not Verified',-1,GETDATE(),0)
	 END
	 SET @EXISTING = -1

	FETCH NEXT FROM RECONLISTS INTO @RECONID 
 END
 CLOSE RECONLISTS
 DEALLOCATE RECONLISTS