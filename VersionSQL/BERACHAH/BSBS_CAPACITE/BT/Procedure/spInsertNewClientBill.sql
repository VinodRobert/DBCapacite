/****** Object:  Procedure [BT].[spInsertNewClientBill]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE BT.spInsertNewClientBill(@PROJECTCODE INT,@BILLNUMBER VARCHAR(15), @DPRDATEFROMSTRING VARCHAR(15), @DPRDATETOSTRING VARCHAR(15))
AS

CREATE TABLE #TEMP0(RESULTCODE INT)

DECLARE @ERRORCODE INT
SET @ERRORCODE = 0


DECLARE @DPRDATEFROM DATETIME 
DECLARE @DPRDATETO   DATETIME 

SET @DPRDATEFROM = CONVERT(DATETIME,@DPRDATEFROMSTRING,103);
SET @DPRDATETO = CONVERT(DATETIME,@DPRDATETOSTRING,103)

DECLARE @COUNTER INT
SELECT @COUNTER = COUNT(*) FROM BT.CLIENTBILL WHERE PROJECTCODE=@PROJECTCODE AND BILLNUMBER=LTRIM(RTRIM(@BILLNUMBER))
IF @COUNTER >=1
 BEGIN
   INSERT INTO #TEMP0 VALUES (1)
   SELECT * FROM #TEMP0 
   RETURN
 END
 
DECLARE @DATEDIFF INT 
SELECT @DATEDIFF = DATEDIFF(DAY,@DPRDATEFROM,@DPRDATETO) 
IF @DATEDIFF <10  
 BEGIN
   INSERT INTO #TEMP0 VALUES (2)
   SELECT * FROM #TEMP0 
   RETURN
 END  

DECLARE @PERIODOVERLAP INT
SET @PERIODOVERLAP = 0
SELECT @PERIODOVERLAP = ISNULL(COUNT(*),0) FROM BT.CLIENTBILL WHERE DPRSTARTDATE>=@DPRDATEFROM AND DPRENDDATE<=@DPRDATETO 
IF @PERIODOVERLAP >0 
BEGIN
  INSERT INTO #TEMP0 VALUES (3)
  SELECT * FROM #TEMP0 
  RETURN
END

INSERT INTO  BT.CLIENTBILL(PROJECTCODE,BILLNUMBER,DPRSTARTDATE,DPRENDDATE)
VALUES (@PROJECTCODE,@BILLNUMBER,@DPRDATEFROM,@DPRDATETO) 
INSERT INTO #TEMP0 VALUES(0)
SELECT * FROM #TEMP0 
RETURN 0