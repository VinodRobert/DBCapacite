/****** Object:  Procedure [BT].[spGetBuget]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE [BT].[spGetBuget](@TEMPLATECODE VARCHAR(15), @PROJECTCODE INT)
AS
DECLARE @RATE DECIMAL(18,2) 

SELECT BM.TEMPLATECODE,BM.MATERIALMAJORHEAD,BM.TEMPLATENAME,BM.CATEGORY,BM.UOM
INTO #TEMP0 
FROM BT.MasterMaterialBudget BM WHERE BM.TEMPLATECODE=@TEMPLATECODE 

SELECT TOOLCODE,SUM(BUDGETQTY) BUDGETQTY ,SUM(BUDGETAMOUNT) BUDGETAMOUNT
INTO #TEMP1 
FROM BT.PROJECTMATERIALBUDGETMASTER  
WHERE TOOLCODE=@TEMPLATECODE AND PROJECTCODE=@PROJECTCODE 
GROUP BY TOOLCODE 

ALTER TABLE #TEMP1 ADD RATE DECIMAL(18,2)

DECLARE @TEMP1COUNT INT
SELECT @TEMP1COUNT =ISNULL( COUNT(*),0) FROM #TEMP1
 

IF @TEMP1COUNT = 0
  INSERT INTO #TEMP1 VALUES (@TEMPLATECODE,0,0,0)

 

SELECT PROJECTMATERIALBUDGETCODE ,BUDGETRATE ,BUDGETAMOUNT
INTO #TEMP2 
FROM BT.PROJECTMATERIALBUDGETMASTER
WHERE TOOLCODE=@TEMPLATECODE AND PROJECTCODE=@PROJECTCODE 
ORDER BY ProjectMaterialBudgetCode DESC 
 
SELECT TOP 1 @RATE = ISNULL(BUDGETRATE,0) FROM #TEMP2 
UPDATE #TEMP1 SET RATE=@RATE WHERE @RATE>0

 
 


SELECT MONTHID,SUM(BUDGETQTY) BUDGETQTY ,SUM(BUDGETAMOUNT) BUDGETAMOUNT
INTO #TEMP3
FROM BT.PROJECTMATERIALBUDGETDETAIL
WHERE PROJECTMATERIALBUDGETID IN 
(SELECT PROJECTMATERIALBUDGETCODE FROM #TEMP2) 
GROUP BY MONTHID 

ALTER TABLE #TEMP3 ADD TOOLCODE VARCHAR(15)
UPDATE #TEMP3 SET TOOLCODE=@TEMPLATECODE 

ALTER TABLE #TEMP3 ADD RATE DECIMAL(18,2)
 
UPDATE #TEMP3 SET RATE = T1.RATE FROM #TEMP1 T1 INNER JOIN #TEMP3 ON #TEMP3.TOOLCODE = T1.TOOLCODE 
 

ALTER TABLE #TEMP3 ADD MONTHSNAME VARCHAR(50)
ALTER TABLE #TEMP3 ADD YEARNAME   VARCHAR(20)

UPDATE #TEMP3 SET MONTHSNAME=MM.MONTHNAME FROM BT.YEARPERIODMASTER MM INNER JOIN #TEMP3 ON #TEMP3.MONTHID=MM.YEARPERIODID 
UPDATE #TEMP3 SET YEARNAME = MM.YEAR FROM BT.YEARPERIODMASTER MM INNER JOIN #TEMP3 ON #TEMP3.MONTHID=MM.YEARPERIODID

SELECT * FROM #TEMP0
SELECT * FROM #TEMP1
SELECT YEARNAME,MONTHSNAME,BUDGETQTY,RATE, BUDGETAMOUNT,MONTHID  FROM #TEMP3 ORDER BY MONTHID 