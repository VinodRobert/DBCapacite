/****** Object:  Procedure [BT].[spFetchDPRMachineryReport]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE [BT].[spFetchDPRMachineryReport](@PROJECTCODE INT, @STARTDATESTRING  VARCHAR(15),@ENDDATESTRING  VARCHAR(15)) 
AS
DECLARE @DPRSTARTDATE DATETIME 
SET @DPRSTARTDATE = CONVERT(DATETIME,@STARTDATESTRING,103)
DECLARE @DPRENDDATE DATETIME 
SET @DPRENDDATE = CONVERT(DATETIME,@ENDDATESTRING,103)

CREATE TABLE #TEMP0(DPRID INT,EQUIPMENTCODE INT,EQUIPMENTNUMBER VARCHAR(20),EQUIPMENTNAME VARCHAR(200),
MAKE VARCHAR(50),MODEL VARCHAR(50),CAPACITY VARCHAR(50),TYPE VARCHAR(50),SHIFTS INT,
STARTREADING DECIMAL(18,2),ENDREADING DECIMAL(18,2),WORKINGHOURS DECIMAL(18,2),
IDLEHOURS DECIMAL(18,2), BREAKDOWNHOURS DECIMAL(18,2),OWNERID INT, DPRDATE DATETIME ) 


INSERT INTO #TEMP0(EQUIPMENTCODE,EQUIPMENTNUMBER,EQUIPMENTNAME,MAKE,MODEL,TYPE,CAPACITY,SHIFTS,OWNERID)
SELECT EQUIPMENTID,EQUIPNUMBER,EQUIPNAME,MAKE,MODEL,CAPACITY,TYPE,SHIFTS,OWNERID FROM BT.EQUIPMENTMASTER 
WHERE PROJECTCODE =@PROJECTCODE AND EQUIPNUMBER IN (SELECT COLKEY FROM ATTRIBVALUE WHERE TABLENAME='PLANTANDEQ' 
 AND ATTRIBUTE='DPR ENTRY'  AND VALUE=1 )

INSERT INTO #TEMP0(EQUIPMENTCODE,EQUIPMENTNUMBER,EQUIPMENTNAME,MAKE,MODEL,TYPE,CAPACITY,SHIFTS,OWNERID)
SELECT EQUIPMENTID,EQUIPNUMBER,EQUIPNAME,MAKE,MODEL,CAPACITY,TYPE,SHIFTS,OWNERID FROM BT.EQUIPMENTMASTER 
WHERE PROJECTCODE =@PROJECTCODE AND  OWNERID=2 AND STATUS=1



SELECT  DPRID,EQUIPMENTCODE,STARTREADING,ENDREADING,WORKINGHOURS,IDLEHOURS,BREAKDOWNHOURS,DPRDATE
INTO #TEMP1 
FROM BT.DPRMachinery WHERE PROJECTCODE=@PROJECTCODE AND DPRDATE BETWEEN @DPRSTARTDATE AND @DPRENDDATE 


UPDATE #TEMP0 SET STARTREADING = T.STARTREADING ,ENDREADING = T.ENDREADING,WORKINGHOURS=T.WORKINGHOURS,
IDLEHOURS =T.IDLEHOURS, BREAKDOWNHOURS = T.BREAKDOWNHOURS, DPRID= T.DPRID , DPRDATE=t.DPRDATE
FROM #TEMP1 T INNER JOIN #TEMP0 ON T.EQUIPMENTCODE = #TEMP0.EQUIPMENTCODE

UPDATE #TEMP0 SET DPRID=0 WHERE DPRID IS NULL
UPDATE #TEMP0 SET STARTREADING = 0 ,ENDREADING = 0 , IDLEHOURS = 0, BREAKDOWNHOURS = 0, WORKINGHOURS=0  WHERE STARTREADING IS NULL

SELECT * FROM #TEMP0 ORDER BY OWNERID , EQUIPMENTNAME 