/****** Object:  Procedure [BI].[spGetPositiveDelivery]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE  PROCEDURE [BI].[spGetPositiveDelivery] (@ORDID INT,@ORDITEMLINENO INT)
AS

SELECT  B.BORGNAME,D.LYEAR,O.ORDNUMBER ,OI.ITEMDESCRIPTION, D.DLVRID,D.DLVRNO,D.GRNNO,(D.DLVRQTY-D.RECONQTY) DLVRQTY,D.ORDID,D.ORDITEMLINENO,ALLOCATED  
INTO #POSITIVE 
FROM DELIVERIES D 
INNER JOIN ORDITEMS OI ON D.ORDID=OI.ORDID AND D.ORDITEMLINENO = OI.LINENUMBER 
INNER JOIN ORD O ON O.ORDID=OI.ORDID  
INNER JOIN BORGS B ON D.TBORGID = B.BORGID 
WHERE D.ORDID = @ORDID AND ORDITEMLINENO = @ORDITEMLINENO AND D.DLVRQTY>0 AND D.LYEAR>=2016
ORDER BY BORGNAME,ITEMDESCRIPTION,ORDNUMBER

ALTER TABLE #POSITIVE ADD RECONSTATUS VARCHAR(25)
UPDATE #POSITIVE SET RECONSTATUS ='Reconciled' WHERE ALLOCATED=1
UPDATE #POSITIVE SET RECONSTATUS ='Un Reconciled' WHERE ALLOCATED=0 
SELECT BORGNAME,LYEAR,ORDNUMBER ,ITEMDESCRIPTION, DLVRID,DLVRNO,GRNNO,DLVRQTY,RECONSTATUS  FROM #POSITIVE WHERE RECONSTATUS='Un Reconciled'