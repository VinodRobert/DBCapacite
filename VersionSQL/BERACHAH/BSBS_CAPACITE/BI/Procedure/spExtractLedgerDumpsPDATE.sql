/****** Object:  Procedure [BI].[spExtractLedgerDumpsPDATE]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE [BI].[spExtractLedgerDumpsPDATE](@STARTDATESTRING VARCHAR(15),@ENDDATESTRING VARCHAR(15),@LISTORGIDS  LISTORGIDS READONLY  )
AS
--EXEC [BI].[spExtractLedgerDumpsForTest]  




DECLARE @TRANSSTARTDATE    DATETIME
DECLARE @TRANSENDDATE      DATETIME
SELECT  @TRANSSTARTDATE = CONVERT(DATETIME, @STARTDATESTRING,103) -- dd/mm/yyyy 
SELECT  @TRANSENDDATE   = CONVERT(DATETIME, @ENDDATESTRING,103) -- dd/mm/yyyy 

 
 
CREATE TABLE #BORGS(BORGID INT)
INSERT INTO #BORGS  
SELECT ORGID  FROM @LISTORGIDS
DELETE FROM #BORGS WHERE BORGID IS NULL



DECLARE @WIP VARCHAR(10)
DECLARE @RETAINED VARCHAR(10)

SELECT @WIP = CONTROLFROMGL FROM CONTROLCODES WHERE CONTROLNAME='Work In Progress'
SELECT @RETAINED = CONTROLFROMGL FROM CONTROLCODES WHERE CONTROLNAME='Retained Income'

 


CREATE TABLE #TEMP0(BOOKINGDATE DATETIME,YEAR INT,PERIOD INT,ORGID INT,PDATE DATETIME,BATCHREF VARCHAR(20),TRANSREF VARCHAR(20),TRANSTYPE VARCHAR(25),LEDGERCODE VARCHAR(25),
                    CONTRACT VARCHAR(20),ACTIVITY VARCHAR(20),DESCRIPTION VARCHAR(400),CURRENCY VARCHAR(25),DEBIT DECIMAL(18,2),CREDIT DECIMAL(18,2),
					CREDNO VARCHAR(15),STORE VARCHAR(25),PLANTNO VARCHAR(25),STOCKNO VARCHAR(25),QUANTITY DECIMAL(18,2),UNIT VARCHAR(20),RATE DECIMAL(18,2),
					ORDERNO VARCHAR(125),HOMECURRAMOUNT DECIMAL(18,2),CONVERSIONRATE DECIMAL(18,2),TRANGRP INT,TRANSID INT, GRN VARCHAR(55),USERID INT ) 
 


	 INSERT INTO #TEMP0 
	 SELECT 
	     T.SYSDATE,
         T.YEAR,
		 T.PERIOD,
		 T.ORGID,
		 T.PDATE,
		 T.BATCHREF,
		 T.TRANSREF,
		 T.TRANSTYPE,
		 T.LEDGERCODE,
		 T.CONTRACT,
	     T.ACTIVITY,
		 T.DESCRIPTION,
		 T.CURRENCY,
		 DEBIT=  CASE 
             WHEN (T.CURRENCY  <> 'INR' ) and T.DEBIT<> 0 THEN T.HOMECURRAMOUNT
             ELSE T.DEBIT
             END,
         CREDIT = CASE 
             WHEN (T.CURRENCY  <> 'INR' ) and T.CREDIT<> 0 THEN T.HOMECURRAMOUNT
             ELSE T.CREDIT
             END ,
		 T.CREDNO,
		 T.STORE,
		 T.PLANTNO,
		 T.STOCKNO,
		 T.QUANTITY,
		 T.UNIT,
		 T.RATE,
		 T.ORDERNO,
		 T.HOMECURRAMOUNT,
		 T.CONVERSIONRATE,
		 T.TRANGRP,
		 T.TRANSID ,
		 T.REQNO AS GRN,
		 T.USERID
	   FROM 
		 TRANSACTIONS T
		WHERE
		  CONVERT(DATE,T.SYSDATE) BETWEEN @TRANSSTARTDATE AND @TRANSENDDATE AND
		  T.ORGID IN (SELECT BORGID FROM #BORGS)

ALTER TABLE #TEMP0 ADD USERNAME VARCHAR(125)
UPDATE #TEMP0 SET USERNAME=U.USERNAME FROM USERS U INNER JOIN #TEMP0 ON #TEMP0.USERID=U.USERID 

ALTER TABLE #TEMP0 ADD PERIODDESC VARCHAR(55)
UPDATE #TEMP0 SET PERIODDESC = PERIODMASTER.PERIODDESC FROM PERIODMASTER INNER JOIN #TEMP0 ON #TEMP0.PERIOD =PERIODMASTER.PERIODID 
ALTER TABLE #TEMP0 ADD BORGNAME VARCHAR(100)
UPDATE #TEMP0 SET BORGNAME =BORGS.BORGNAME FROM BORGS INNER JOIN #TEMP0 ON #TEMP0.ORGID=BORGS.BORGID 

ALTER TABLE #TEMP0 ADD LEDGERNAME VARCHAR(250)
UPDATE #TEMP0 SET LEDGERNAME =LEFT(LEDGERCODES.LEDGERNAME,250) FROM LEDGERCODES INNER JOIN #TEMP0 ON #TEMP0.LEDGERCODE=LEDGERCODES.LEDGERCODE 

ALTER TABLE #TEMP0 ADD CONTRACTNAME VARCHAR(100)
UPDATE #TEMP0 SET CONTRACTNAME = LEFT(CONTRACTS.CONTRNAME,100) FROM CONTRACTS INNER JOIN #TEMP0 ON #TEMP0.CONTRACT = CONTRACTS.CONTRNUMBER

ALTER TABLE #TEMP0 ADD ACTIVITIYNAME VARCHAR(100)
UPDATE #TEMP0 SET ACTIVITIYNAME = LEFT(ACTIVITIES.ACTNAME,100) FROM ACTIVITIES INNER JOIN #TEMP0 ON #TEMP0.Activity = ACTIVITIES.ACTNUMBER 

ALTER TABLE #TEMP0 ADD PARTY  VARCHAR(255)
UPDATE #TEMP0 SET PARTY=LEFT([BS].[fnGetParty](CREDNO) ,255)  

ALTER TABLE #TEMP0 ADD PLANTNAME VARCHAR(200)
UPDATE #TEMP0 SET PLANTNAME=LEFT(PLANTANDEQ.PENAME,200) FROM PLANTANDEQ INNER JOIN #TEMP0 ON #TEMP0.PLANTNO=PLANTANDEQ.PENUMBER

ALTER TABLE #TEMP0 ADD STOCKNAME VARCHAR(200)
UPDATE #TEMP0 SET STOCKNAME = LEFT(INVENTORY.STKDESC,200) FROM INVENTORY INNER JOIN #TEMP0 ON #TEMP0.STOCKNO=INVENTORY.STKCODE  WHERE INVENTORY.STKSTORE='VMAINSTORE'  

ALTER TABLE #TEMP0 ADD ALLOCATION VARCHAR(20)
UPDATE #TEMP0 SET ALLOCATION = LEFT(LEDGERALLOC,20) FROM LEDGERCODES INNER JOIN #TEMP0 ON #TEMP0.LEDGERCODE = LEDGERCODES.LEDGERCODE 

  
SELECT  
         BOOKINGDATE,
		 USERNAME,
		 ORGID,
		 BORGNAME,
		 YEAR,
		 PERIOD,
		 PERIODDESC,
		 PDATE,
		 BATCHREF,
		 TRANSREF,
		 TRANSTYPE,
		 LEDGERCODE,
		 LEDGERNAME,
	     ALLOCATION,
		 CONTRACTNAME,
		 ACTIVITIYNAME,
		 DESCRIPTION,
		 CURRENCY,
		 DEBIT,
		 CREDIT,
		 CREDNO,
		 PARTY,
		 STORE,
		 PLANTNO,	
		 PLANTNAME,
		 STOCKNO,
		 STOCKNAME,
		 QUANTITY,
		 UNIT,
		 RATE,
		 ORDERNO,
		 HOMECURRAMOUNT,
		 CONVERSIONRATE,
		 TRANGRP ,
		 GRN
FROM #TEMP0 
ORDER BY
ORGID,BOOKINGDATE 