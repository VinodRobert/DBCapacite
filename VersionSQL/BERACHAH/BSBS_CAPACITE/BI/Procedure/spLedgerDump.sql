/****** Object:  Procedure [BI].[spLedgerDump]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE [BI].[spLedgerDump](@YEAR INT,@RANGEID INT,@FROMPERIOD INT,@TOPERIOD INT,
                                    @STARTDATESTRING VARCHAR(15),@ENDDATESTRING VARCHAR(15),
									@LISTLEDGERIDS  LISTLEDGERIDS  READONLY  ,@LISTORGIDS  LISTORGIDS READONLY  )
AS

--declare @year int
--declare @fromperiod int
--declare @toperiod int

--set @year=2017
--set @fromperiod = 1
--set @toperiod = 1 
 
DECLARE @TRANSSTARTDATE    DATETIME
DECLARE @TRANSENDDATE      DATETIME
SELECT  @TRANSSTARTDATE = CONVERT(DATETIME, @STARTDATESTRING,103) -- dd/mm/yyyy 
SELECT  @TRANSENDDATE   = CONVERT(DATETIME, @ENDDATESTRING,103) -- dd/mm/yyyy 

IF @TOPERIOD=0 
   SET @TOPERIOD = @FROMPERIOD 

CREATE TABLE #LEDGERIDS(LEDGERID INT)
INSERT INTO #LEDGERIDS  
SELECT LEDGERID FROM @LISTLEDGERIDS
DELETE FROM #LEDGERIDS WHERE LEDGERID IS NULL 

ALTER TABLE #LEDGERIDS ADD LEDGERCODE VARCHAR(10)
UPDATE #LEDGERIDS SET LEDGERCODE = L.LEDGERCODE FROM LEDGERCODES L INNER JOIN #LEDGERIDS LI ON LI.LEDGERID= L.LEDGERID 


CREATE TABLE #BORGS(ORGID INT)
INSERT INTO #BORGS  
SELECT ORGID  FROM @LISTORGIDS
DELETE FROM #BORGS WHERE ORGID IS NULL

 

--CREATE TABLE #TEMP1(INDEXID INT PRIMARY KEY IDENTITY(1,1), ORGID INT, PROJECT VARCHAR(450),YEAR INT,PERIOD INT,MONTH VARCHAR(60),
--BATCHREF VARCHAR(40),TRANSREF VARCHAR(40),TRANSTYPE VARCHAR(45),ALLOCATION VARCHAR(40),LEDGERCODE VARCHAR(40), LEDGERNAME VARCHAR(250),
--CONTRACT VARCHAR(40),CONTRACTNAME VARCHAR(100),ACTIVITYCODE VARCHAR(40),ACTIVITY VARCHAR(100),DESCRIPTION VARCHAR(250),CURRENCY VARCHAR(40),
--DEBIT DECIMAL(18,2),CREDIT DECIMAL(18,2),PARTYCODE VARCHAR(40), PARTYNAME VARCHAR(200),STORE VARCHAR(45),PLANTNO VARCHAR(45),
--STOCKNAME VARCHAR(200),QUANTITY DECIMAL(18,2),UNIT VARCHAR(40),RATE DECIMAL(18,2),ORDERNUMBER VARCHAR(40),HOMECURRENCY DECIMAL(18,2),
--CONVERTIONRATE DECIMAL(18,2),LOGINUSER VARCHAR(40),USERNAME VARCHAR(45),DIVISIONID VARCHAR(40),TRANGRP INT,TRANSID INT) 
IF @RANGEID = 1
 BEGIN
    SELECT 
		 T.ORGID,
		 LEFT(B.BORGNAME,150) BORGNAME,
		 T.YEAR,
		 T.PERIOD,
		 P.PERIODDESC,
		 T.PDATE,
		 T.BATCHREF,
		 T.TRANSREF,
		 T.TRANSTYPE,
		 T.ALLOCATION,
		 T.LEDGERCODE,
		 LEFT(L.LEDGERNAME,250) LEDGERNAME,
		 T.CONTRACT,
		 C.CONTRNAME,
		 T.ACTIVITY,
		 A.ACTNAME,
		 T.DESCRIPTION,
		 T.CURRENCY,
		 T.DEBIT,
		 T.CREDIT,
		 T.CREDNO,
		 [BS].[fnGetParty](T.CREDNO) PARTY,
		 T.STORE,
		 T.PLANTNO,
		 T.STOCKNO,
		 I.STKDESC,
		 T.QUANTITY,
		 T.UNIT,
		 T.RATE,
		 T.ORDERNO,
		 T.HOMECURRAMOUNT,
		 T.CONVERSIONRATE,
		 T.USERID,
		 T.TRANGRP,
		 T.TRANSID,
		 T.REQNO AS GRN
		INTO #TEMP0
		FROM 
		 TRANSACTIONS T
		 INNER JOIN BORGS B ON T.ORGID = B.BORGID
		 INNER JOIN LEDGERCODES L ON T.LEDGERCODE = L.LEDGERCODE 
		 LEFT  JOIN INVENTORY I ON T.STOCKNO = I.STKCODE 
		 INNER JOIN PERIODMASTER P ON T.PERIOD = P.PERIODID 
		 LEFT  JOIN ACTIVITIES A ON T.ACTIVITY = A.ACTNUMBER 
		 LEFT  JOIN CONTRACTS C ON T.CONTRACT = C.CONTRNUMBER
		WHERE
		 T.LEDGERCODE IN (SELECT LEDGERCODE FROM #LEDGERIDS) AND 
		 T.ORGID IN (SELECT ORGID FROM #BORGS) AND 
		 T.YEAR = @YEAR AND 
		 T.PERIOD BETWEEN @FROMPERIOD AND @TOPERIOD 
	 SELECT * FROM #TEMP0 
 END
 
ELSE
 BEGIN
     SELECT 
		 T.ORGID,
		 LEFT(B.BORGNAME,150) BORGNAME,
		 T.YEAR,
		 T.PERIOD,
		 P.PERIODDESC,
		 T.PDATE,
		 T.BATCHREF,
		 T.TRANSREF,
		 T.TRANSTYPE,
		 T.ALLOCATION,
		 T.LEDGERCODE,
		 LEFT(L.LEDGERNAME,250) LEDGERNAME,
		 T.CONTRACT,
		 C.CONTRNAME,
		 T.ACTIVITY,
		 A.ACTNAME,
		 T.DESCRIPTION,
		 T.CURRENCY,
		 T.DEBIT,
		 T.CREDIT,
		 T.CREDNO,
		 [BS].[fnGetParty](T.CREDNO) PARTY,
		 T.STORE,
		 T.PLANTNO,
		 T.STOCKNO,
		 I.STKDESC,
		 T.QUANTITY,
		 T.UNIT,
		 T.RATE,
		 T.ORDERNO,
		 T.HOMECURRAMOUNT,
		 T.CONVERSIONRATE,
		 T.USERID,
		 T.TRANGRP,
		 T.TRANSID,
		 T.REQNO AS GRN
		INTO #TEMP1
		FROM 
		 TRANSACTIONS T
		 INNER JOIN BORGS B ON T.ORGID = B.BORGID
		 INNER JOIN LEDGERCODES L ON T.LEDGERCODE = L.LEDGERCODE 
		 LEFT  JOIN INVENTORY I ON T.STOCKNO = I.STKCODE 
		 INNER JOIN PERIODMASTER P ON T.PERIOD = P.PERIODID 
		 LEFT  JOIN ACTIVITIES A ON T.ACTIVITY = A.ACTNUMBER 
		 LEFT  JOIN CONTRACTS C ON T.CONTRACT = C.CONTRNUMBER
		WHERE
		 T.LEDGERCODE IN (SELECT LEDGERCODE FROM #LEDGERIDS) AND 
		 T.ORGID IN (SELECT ORGID FROM #BORGS) AND 
		 T.YEAR = @YEAR AND 
		 T.PDATE BETWEEN @TRANSSTARTDATE AND @TRANSENDDATE 
	 SELECT * FROM #TEMP1 
 END




 
 