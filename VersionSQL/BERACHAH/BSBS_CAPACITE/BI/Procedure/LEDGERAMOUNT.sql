/****** Object:  Procedure [BI].[LEDGERAMOUNT]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE [BI].[LEDGERAMOUNT]( @LISTORGIDS  LISTORGIDS READONLY,  @GROUPHEADERID INT ,@CYFP INT, @CYTP INT, @PYFP INT, @PYTP INT, @FINYEAR INT )
AS
 
 
CREATE TABLE #CURRENTYEAR (  YEAR INT,PERIOD INT,  LEDGERCODE VARCHAR(10), AMOUNT DECIMAL(18,2) )
CREATE TABLE #PREVIOUSYEAR(  YEAR INT,PERIOD INT,  LEDGERCODE VARCHAR(10), AMOUNT DECIMAL(18,2) )

CREATE TABLE #BORGS(ORGID INT)
INSERT INTO #BORGS   
SELECT ORGID  FROM @LISTORGIDS
DELETE FROM #BORGS WHERE ORGID IS NULL

DECLARE @MONTHCOUNT INT

DECLARE @MONTHNAME VARCHAR(50) 
DECLARE @CURRENTSUM DECIMAL(18,2)
DECLARE @LEDGERCODE VARCHAR(10) 
DECLARE @EXPENSEHEADID INT

DECLARE @LEDGERSUM VARCHAR(10) 

DECLARE @SUBLEDGER  INT

CREATE TABLE #RESULT
  (
    EXPENSEHEADID INT,
    CURRENTYEAR INT,
    PERIOD INT,
	CURRMONTH VARCHAR(15),
	CURRMONTHAMOUNT DECIMAL(18,2) , 
	PERCENTAGE DECIMAL(18,2),
	PREVIOUSYEAR INT,
	PREVMONTH VARCHAR(15),
	PREVMONTHAMOUNT DECIMAL(18,2),
	VARIANCE DECIMAL(18,2),
	VARIANCEPERCENTAGE DECIMAL(18,2)
  ) 

CREATE TABLE #SUBBIEWISE_CURRENT
(
    LEDGERCODE VARCHAR(10),
	LEDGERNAME VARCHAR(50),
 	CREDNO VARCHAR(10),
	SUBCONTRACTOR  VARCHAR(100),
	APRIL DECIMAL(18,2),
	MAY   DECIMAL(18,2),
	JUNE  DECIMAL(18,2),
	JULY  DECIMAL(18,2),
	AUGUST DECIMAL(18,2),
	SEPTEMBER DECIMAL(18,2),
	OCTOBER   DECIMAL(18,2),
	NOVEMBER  DECIMAL(18,2),
	DECEMBER  DECIMAL(18,2),
	JANUARY   DECIMAL(18,2),
	FEBRUARY  DECIMAL(18,2),
	MARCH     DECIMAL(18,2),
	TOTAL     DECIMAL(18,2) 
)

CREATE TABLE #SUBBIEWISE_PREVIOUS
(
    LEDGERCODE VARCHAR(10),
	LEDGERNAME VARCHAR(50),
  	CREDNO VARCHAR(10),
	SUBCONTRACTOR  VARCHAR(100),
	APRIL DECIMAL(18,2),
	MAY   DECIMAL(18,2),
	JUNE  DECIMAL(18,2),
	JULY  DECIMAL(18,2),
	AUGUST DECIMAL(18,2),
	SEPTEMBER DECIMAL(18,2),
	OCTOBER   DECIMAL(18,2),
	NOVEMBER  DECIMAL(18,2),
	DECEMBER  DECIMAL(18,2),
	JANUARY   DECIMAL(18,2),
	FEBRUARY  DECIMAL(18,2),
	MARCH     DECIMAL(18,2),
	TOTAL     DECIMAL(18,2) 
)


CREATE TABLE #SUBBIEWISE 
(
  LEDGERCODE VARCHAR(10),
  CREDNO VARCHAR(10),
  CREDNAME VARCHAR(150),
  PERIOD INT,
  PERIODNAME VARCHAR(25),
  AMOUNT DECIMAL(18,2)
)
 

 
CREATE TABLE #CYEAR(YEAR INT,PERIOD INT,AMOUNT DECIMAL(18,2))
CREATE TABLE #PYEAR(YEAR INT,PERIOD INT,AMOUNT DECIMAL(18,2))

SELECT GH.GROUPLEDGERCODE,GH.GROUPLEDGERNAME,GD.LEDGERCODE,GD.LEDGERNAME 
INTO #LEDGERLISTS
FROM GROUPLEDGERHEAD GH INNER JOIN GROUPLEDGERDETAIL GD ON GH.GROUPLEDGERCODE = GD.GROUPLEDGERCODE
WHERE GH.GROUPLEDGERCODE = @GROUPHEADERID 



SELECT LEDGERCODE
INTO #LEDGERCODES 
FROM #LEDGERLISTS



SET @SUBLEDGER = 0
SELECT @SUBLEDGER = SUBLEDGERAPPLICABLE FROM BI.GROUPLEDGERHEAD WHERE GROUPLEDGERCODE = @GROUPHEADERID



SET @MONTHCOUNT = 1
  
WHILE @MONTHCOUNT<=12 
  BEGIN
    SELECT @MONTHNAME = PERIODDESC FROM PERIODMASTER WHERE PERIODID=@MONTHCOUNT 

    INSERT INTO #RESULT(EXPENSEHEADID,CURRENTYEAR,PERIOD,CURRMONTH,PREVIOUSYEAR,PREVMONTH)
	SELECT 
	  @GROUPHEADERID,@FINYEAR,@MONTHCOUNT,(@MONTHNAME+'-'+LTRIM(STR(@FINYEAR,4))),@FINYEAR-1,(@MONTHNAME+'-'+LTRIM(STR(@FINYEAR-1,4)) )

	SET @MONTHCOUNT = @MONTHCOUNT + 1
  
END 
UPDATE #RESULT SET CURRMONTHAMOUNT=0,PREVMONTHAMOUNT =0 


 
  
DELETE FROM #CYEAR
DELETE FROM #PYEAR

INSERT INTO #CURRENTYEAR 
	  SELECT 
			T.YEAR,
			T.PERIOD,
			T.LEDGERCODE,
			SUM(T.DEBIT-T.CREDIT) AMOUNT 
		FROM 
			TRANSACTIONS  T  
		WHERE 
		    LEDGERCODE IN (SELECT LEDGERCODE FROM  #LEDGERCODES )  AND
			T.ORGID IN (SELECT ORGID FROM #BORGS) AND
			YEAR = @FINYEAR AND 
			PERIOD BETWEEN @CYFP AND @CYTP  
		GROUP BY 
			YEAR,PERIOD,LEDGERCODE 
 
INSERT INTO #PREVIOUSYEAR
	  SELECT 
			YEAR,
			PERIOD,
			LEDGERCODE,
			SUM(DEBIT-CREDIT) AMOUNT 
	  FROM 
		    TRANSACTIONS T  
	  WHERE 
	        LEDGERCODE IN (SELECT LEDGERCODE FROM  #LEDGERCODES )  AND
			T.ORGID IN (SELECT ORGID FROM #BORGS) AND
			YEAR = @FINYEAR-1 AND 
			PERIOD BETWEEN @PYFP AND @PYTP 
	  GROUP BY 
		    YEAR,PERIOD,LEDGERCODE 
   
INSERT INTO #CYEAR 
  SELECT YEAR,PERIOD,SUM(AMOUNT) AMOUNT 
  FROM #CURRENTYEAR 
  GROUP BY YEAR,PERIOD

INSERT INTO #PYEAR 
  SELECT YEAR,PERIOD,SUM(AMOUNT) AMOUNT
  FROM #PREVIOUSYEAR
  GROUP BY YEAR,PERIOD 




UPDATE #RESULT SET CURRMONTHAMOUNT = CURRMONTHAMOUNT+  #CYEAR.AMOUNT FROM #CYEAR INNER JOIN #RESULT ON  #RESULT.PERIOD = #CYEAR.PERIOD  

UPDATE #RESULT SET PREVMONTHAMOUNT = PREVMONTHAMOUNT+  #PYEAR.AMOUNT FROM #PYEAR INNER JOIN #RESULT ON  #RESULT.PERIOD = #PYEAR.PERIOD  

 
SELECT @CURRENTSUM = SUM(CURRMONTHAMOUNT) FROM #RESULT 
UPDATE #RESULT SET PERCENTAGE = ( CURRMONTHAMOUNT / @CURRENTSUM )*100.00  WHERE   PERIOD BETWEEN @CYFP AND  @CYTP AND @CURRENTSUM>0

UPDATE #RESULT SET VARIANCE = ( CURRMONTHAMOUNT - PREVMONTHAMOUNT )  WHERE  PERIOD BETWEEN @CYFP AND  @CYTP
UPDATE #RESULT SET VARIANCEPERCENTAGE  = ( VARIANCE  /  PREVMONTHAMOUNT ) *100.00 WHERE   VARIANCE<>0 AND PREVMONTHAMOUNT >0
UPDATE #RESULT SET VARIANCE = 0 WHERE VARIANCE IS NULL
UPDATE #RESULT SET VARIANCEPERCENTAGE = 0 WHERE VARIANCEPERCENTAGE IS NULL 
  
DELETE FROM #CURRENTYEAR 
DELETE FROM #PREVIOUSYEAR
DELETE FROM #CYEAR
DELETE FROM #PYEAR 



IF @SUBLEDGER = 1
BEGIN
    INSERT INTO #SUBBIEWISE(LEDGERCODE,CREDNO,PERIOD,AMOUNT)
    SELECT LEDGERCODE,CREDNO,PERIOD,SUM(DEBIT-CREDIT) AMOUNT 
	FROM TRANSACTIONS 
    WHERE YEAR=@FINYEAR AND
	      ORGID IN (  SELECT ORGID FROM #BORGS ) AND 
		  LEDGERCODE IN ( SELECT LEDGERCODE FROM  #LEDGERCODES ) AND
          PERIOD BETWEEN @CYFP AND @CYTP 
    GROUP BY LEDGERCODE,CREDNO,PERIOD 


	UPDATE #SUBBIEWISE SET CREDNAME = S.SUBNAME FROM SUBCONTRACTORS S INNER JOIN #SUBBIEWISE ON #SUBBIEWISE.CREDNO=S.SUBNUMBER 
	UPDATE #SUBBIEWISE SET CREDNAME = C.CREDNAME FROM CREDITORS C INNER JOIN #SUBBIEWISE ON #SUBBIEWISE.CREDNO=C.CREDNUMBER 
	UPDATE #SUBBIEWISE SET CREDNAME = D.DEBTNAME FROM DEBTORS D INNER JOIN #SUBBIEWISE ON #SUBBIEWISE.CREDNO = D.DEBTNUMBER 

	UPDATE #SUBBIEWISE SET PERIODNAME = P.PERIODDESC FROM PERIODMASTER P INNER JOIN #SUBBIEWISE ON #SUBBIEWISE.PERIOD = P.PERIODID 
	UPDATE #SUBBIEWISE SET CREDNAME = 'NO SUPPLIER'  WHERE CREDNO='' 
	
	 
	
	INSERT INTO #SUBBIEWISE_CURRENT(LEDGERCODE,CREDNO,SUBCONTRACTOR)
	SELECT DISTINCT LEDGERCODE, CREDNO, CREDNAME+'('+ RTRIM(CREDNO) +')' FROM #SUBBIEWISE

 
	UPDATE #SUBBIEWISE_CURRENT SET APRIL = AMOUNT FROM #SUBBIEWISE
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND 
	             #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE   WHERE  #SUBBIEWISE.PERIOD=1
	UPDATE #SUBBIEWISE_CURRENT SET MAY = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND 
	             #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=2
	UPDATE #SUBBIEWISE_CURRENT SET JUNE = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND 
	             #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=3
	UPDATE #SUBBIEWISE_CURRENT SET JULY = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=4
	UPDATE #SUBBIEWISE_CURRENT SET AUGUST = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=5
	UPDATE #SUBBIEWISE_CURRENT SET SEPTEMBER = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=6
	UPDATE #SUBBIEWISE_CURRENT SET OCTOBER = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE   WHERE  #SUBBIEWISE.PERIOD=7
	UPDATE #SUBBIEWISE_CURRENT SET NOVEMBER = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE   WHERE  #SUBBIEWISE.PERIOD=8
	UPDATE #SUBBIEWISE_CURRENT SET DECEMBER = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE   WHERE  #SUBBIEWISE.PERIOD=9
	UPDATE #SUBBIEWISE_CURRENT SET JANUARY = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE  WHERE  #SUBBIEWISE.PERIOD=10
	UPDATE #SUBBIEWISE_CURRENT SET FEBRUARY = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND 
	       #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=11
	UPDATE #SUBBIEWISE_CURRENT SET MARCH = AMOUNT FROM #SUBBIEWISE
	  INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.CREDNO=#SUBBIEWISE.CREDNO AND
	       #SUBBIEWISE_CURRENT.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=12


    UPDATE #SUBBIEWISE_CURRENT SET LEDGERNAME = L.LEDGERNAME FROM LEDGERCODES L INNER JOIN #SUBBIEWISE_CURRENT ON #SUBBIEWISE_CURRENT.LEDGERCODE=L.LEDGERCODE 
    
    DELETE FROM  #SUBBIEWISE

	INSERT INTO #SUBBIEWISE(LEDGERCODE,CREDNO,PERIOD,AMOUNT) 
    SELECT LEDGERCODE,CREDNO,PERIOD,SUM(DEBIT-CREDIT) AMOUNT 
	FROM TRANSACTIONS 
    WHERE YEAR=@FINYEAR-1 AND
	      ORGID IN (  SELECT ORGID FROM #BORGS ) AND 
		  LEDGERCODE IN ( SELECT LEDGERCODE FROM  #LEDGERCODES ) AND
          PERIOD BETWEEN @CYFP AND @CYTP 
    GROUP BY LEDGERCODE,CREDNO,PERIOD 
	
	UPDATE #SUBBIEWISE SET CREDNAME = S.SUBNAME FROM SUBCONTRACTORS S INNER JOIN #SUBBIEWISE ON #SUBBIEWISE.CREDNO=S.SUBNUMBER 
	UPDATE #SUBBIEWISE SET CREDNAME = C.CREDNAME FROM CREDITORS C INNER JOIN #SUBBIEWISE ON #SUBBIEWISE.CREDNO=C.CREDNUMBER 
	UPDATE #SUBBIEWISE SET CREDNAME = D.DEBTNAME FROM DEBTORS D INNER JOIN #SUBBIEWISE ON #SUBBIEWISE.CREDNO = D.DEBTNUMBER 
	UPDATE #SUBBIEWISE SET PERIODNAME = P.PERIODDESC FROM PERIODMASTER P INNER JOIN #SUBBIEWISE ON #SUBBIEWISE.PERIOD = P.PERIODID 
	UPDATE #SUBBIEWISE SET CREDNAME = 'NO SUPPLIER'  WHERE CREDNO='' 
	INSERT INTO #SUBBIEWISE_PREVIOUS(LEDGERCODE,CREDNO,SUBCONTRACTOR)
	SELECT DISTINCT LEDGERCODE,CREDNO, CREDNAME+'('+ RTRIM(CREDNO) +')' FROM #SUBBIEWISE
	
	UPDATE #SUBBIEWISE_PREVIOUS SET APRIL = AMOUNT FROM #SUBBIEWISE
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND 
	             #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE   WHERE  #SUBBIEWISE.PERIOD=1
	UPDATE #SUBBIEWISE_PREVIOUS SET MAY = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND 
	             #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=2
	UPDATE #SUBBIEWISE_PREVIOUS SET JUNE = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND 
	             #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=3
	UPDATE #SUBBIEWISE_PREVIOUS SET JULY = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=4
	UPDATE #SUBBIEWISE_PREVIOUS SET AUGUST = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=5
	UPDATE #SUBBIEWISE_PREVIOUS SET SEPTEMBER = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=6
	UPDATE #SUBBIEWISE_PREVIOUS SET OCTOBER = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE   WHERE  #SUBBIEWISE.PERIOD=7
	UPDATE #SUBBIEWISE_PREVIOUS SET NOVEMBER = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE   WHERE  #SUBBIEWISE.PERIOD=8
	UPDATE #SUBBIEWISE_PREVIOUS SET DECEMBER = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE   WHERE  #SUBBIEWISE.PERIOD=9
	UPDATE #SUBBIEWISE_PREVIOUS SET JANUARY = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND
	             #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE  WHERE  #SUBBIEWISE.PERIOD=10
	UPDATE #SUBBIEWISE_PREVIOUS SET FEBRUARY = AMOUNT FROM #SUBBIEWISE 
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND 
	       #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=11
	UPDATE #SUBBIEWISE_PREVIOUS SET MARCH = AMOUNT FROM #SUBBIEWISE
	  INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.CREDNO=#SUBBIEWISE.CREDNO AND
	       #SUBBIEWISE_PREVIOUS.LEDGERCODE =#SUBBIEWISE.LEDGERCODE WHERE  #SUBBIEWISE.PERIOD=12

    UPDATE #SUBBIEWISE_PREVIOUS SET LEDGERNAME = L.LEDGERNAME FROM LEDGERCODES L INNER JOIN #SUBBIEWISE_PREVIOUS ON #SUBBIEWISE_PREVIOUS.LEDGERCODE=L.LEDGERCODE 
END

UPDATE #SUBBIEWISE_CURRENT SET APRIL=0 WHERE APRIL IS NULL
UPDATE #SUBBIEWISE_CURRENT SET MAY=0 WHERE MAY IS NULL
UPDATE #SUBBIEWISE_CURRENT SET JUNE=0 WHERE JUNE IS NULL
UPDATE #SUBBIEWISE_CURRENT SET JULY=0 WHERE JULY IS NULL
UPDATE #SUBBIEWISE_CURRENT SET AUGUST=0 WHERE AUGUST IS NULL
UPDATE #SUBBIEWISE_CURRENT SET SEPTEMBER=0 WHERE SEPTEMBER IS NULL
UPDATE #SUBBIEWISE_CURRENT SET OCTOBER=0 WHERE OCTOBER IS NULL
UPDATE #SUBBIEWISE_CURRENT SET NOVEMBER=0 WHERE NOVEMBER IS NULL
UPDATE #SUBBIEWISE_CURRENT SET DECEMBER=0 WHERE DECEMBER IS NULL
UPDATE #SUBBIEWISE_CURRENT SET JANUARY=0 WHERE JANUARY IS NULL
UPDATE #SUBBIEWISE_CURRENT SET FEBRUARY=0 WHERE FEBRUARY IS NULL
UPDATE #SUBBIEWISE_CURRENT SET MARCH =0 WHERE MARCH IS NULL
UPDATE #SUBBIEWISE_CURRENT SET TOTAL = APRIL+MAY+JUNE+JULY+AUGUST+SEPTEMBER+OCTOBER+NOVEMBER+DECEMBER+JANUARY+FEBRUARY+MARCH 
UPDATE #SUBBIEWISE_PREVIOUS SET APRIL=0 WHERE APRIL IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET MAY=0 WHERE MAY IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET JUNE=0 WHERE JUNE IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET JULY=0 WHERE JULY IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET AUGUST=0 WHERE AUGUST IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET SEPTEMBER=0 WHERE SEPTEMBER IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET OCTOBER=0 WHERE OCTOBER IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET NOVEMBER=0 WHERE NOVEMBER IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET DECEMBER=0 WHERE DECEMBER IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET JANUARY=0 WHERE JANUARY IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET FEBRUARY=0 WHERE FEBRUARY IS NULL
UPDATE #SUBBIEWISE_PREVIOUS SET MARCH =0 WHERE MARCH IS NULL
UPDATE #SUBBIEWISE_PREVIOUS  SET TOTAL = APRIL+MAY+JUNE+JULY+AUGUST+SEPTEMBER+OCTOBER+NOVEMBER+DECEMBER+JANUARY+FEBRUARY+MARCH 
 

 

SELECT * FROM #RESULT 
IF @SUBLEDGER = 1 
BEGIN
   SELECT * FROM #SUBBIEWISE_CURRENT   ORDER BY LEDGERCODE,CREDNO 
   SELECT * FROM #SUBBIEWISE_PREVIOUS  ORDER BY LEDGERCODE,CREDNO 
END
 