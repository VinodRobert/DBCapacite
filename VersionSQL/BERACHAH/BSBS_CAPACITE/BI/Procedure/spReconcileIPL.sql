/****** Object:  Procedure [BI].[spReconcileIPL]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE [BI].[spReconcileIPL](@FINYEAR INT,@STARTPERIOD INT, @ENDPERIOD INT,@REFERNCESITEID INT,@REFERREDTOSITES INT)
AS
SELECT BORGID,ICGLCODE LEDGERCODE INTO #IPLA FROM BORGS WHERE ICGLCODE IS NOT NULL
DECLARE @IPLTRANGRP VARCHAR(10)
DECLARE @REFERENCESITEIPLA VARCHAR(10)
SELECT @REFERENCESITEIPLA = LEDGERCODE FROM #IPLA WHERE BORGID=@REFERNCESITEID	

 


DECLARE @SPLITCOUNT INT 
DECLARE @TOORG INT
DECLARE @I INT 
DECLARE @TOLEDGER VARCHAR(10)
DECLARE @TRANSDATE DATETIME
DECLARE @NARRATION VARCHAR(200)
DECLARE @FROMORG VARCHAR(10)
DECLARE @SUBLEDGER VARCHAR(10)
DECLARE @TRANSTYPE VARCHAR(3)
DECLARE @LOANAMOUNT DECIMAL(18,2)
DECLARE @FROMLEDGER VARCHAR(10)
DECLARE @BATCHREF VARCHAR(10)
DECLARE @TRANSREF VARCHAR(25)
DECLARE @STARTTRANSID INT
DECLARE @ENDTRANSID INT
DECLARE @COUNTS INT
DECLARE @WIP VARCHAR(10)
DECLARE @RETAINED VARCHAR(10)
SET @WIP = '2990000'    
SET @RETAINED = '1100005   '  

CREATE TABLE #SPLITENTRIES(TRANGRP INT)
CREATE TABLE #SPLITSECTION( TRANSID INT ,LEDGERCODE  VARCHAR(10), DEBIT DECIMAL(18,2) ,CREDIT DECIMAL(18,2),ORGID INT  ) 
CREATE TABLE #SPLITVALUES (TRANSID INT, CREDIT DECIMAL(18,2),OPPLEDGER VARCHAR(10),TOORG INT) 

 
CREATE TABLE #DISTRIBUTION(
            COUNTER INT PRIMARY KEY IDENTITY(1,1),
			TRANGRP INT ,
			TRANSTYPE VARCHAR(3),
			BATCHREF VARCHAR(10),
			TRANSREF VARCHAR(25),
            FROMORG INT,
			FROMLEDGER   VARCHAR(10),
			TRANSDATE DATETIME, 
			FROMAMOUNT DECIMAL(18,2), 
			TOORG INT, 
			TOLEDGER VARCHAR(10), 
			TOSUBLEDGER VARCHAR(10), 
			TOAMOUNT DECIMAL(18,2),
			NARRATION VARCHAR(200) ) 

SELECT DISTINCT TRANGRP FROM TRANSACTIONS WHERE 
YEAR=@FINYEAR AND PERIOD BETWEEN @STARTPERIOD AND @ENDPERIOD AND LEDGERCODE= @REFERENCESITEIPLA  AND LEFT(TRANSTYPE,3)='JNL' 


DECLARE IPLATRANGRP CURSOR 
FOR 
SELECT DISTINCT TRANGRP FROM TRANSACTIONS WHERE 
YEAR=@FINYEAR AND PERIOD BETWEEN @STARTPERIOD AND @ENDPERIOD AND LEDGERCODE= @REFERENCESITEIPLA   AND TRANGRP = 1607942



OPEN IPLATRANGRP
FETCH NEXT FROM IPLATRANGRP INTO @IPLTRANGRP 

WHILE @@FETCH_STATUS = 0
BEGIN
  --SELECT * FROM TRANSACTIONS WHERE TRANGRP = @IPLTRANGRP 
  SELECT @STARTTRANSID = MIN(TRANSID), @ENDTRANSID = MAX(TRANSID) FROM TRANSACTIONS WHERE TRANGRP = @IPLTRANGRP 
  SELECT @COUNTS = COUNT(*) FROM TRANSACTIONS  WHERE TRANGRP = @IPLTRANGRP  
  IF @COUNTS<>4 
     INSERT INTO #SPLITENTRIES(TRANGRP) VALUES ( @IPLTRANGRP )
  ELSE 
   BEGIN
	  SET @LOANAMOUNT = 0
	  SET @TOORG = 0
	  SET @SUBLEDGER = ''
	  SELECT 
		@TOORG = ORGID, 
		@SUBLEDGER=CREDNO ,
		@TRANSTYPE = LEFT(BATCHREF,3),
		@LOANAMOUNT = (CREDIT-DEBIT) ,
		@NARRATION = LEFT(DESCRIPTION,200) ,
		@TRANSDATE = PDATE,
		@BATCHREF = BATCHREF,
		@TRANSREF = TRANSREFEXT 
	  FROM 
		TRANSACTIONS 
	  WHERE 
		TRANGRP=@IPLTRANGRP AND LEDGERCODE= @REFERENCESITEIPLA   
 
	  SELECT @TOLEDGER = LEDGERCODE 
	  FROM TRANSACTIONS 
	  WHERE TRANGRP=@IPLTRANGRP AND LEDGERCODE NOT IN (SELECT LEDGERCODE FROM #IPLA) AND (DEBIT-CREDIT)  = @LOANAMOUNT 
	  AND LEDGERCODE NOT IN (@WIP,@RETAINED)
 
	  SELECT @FROMLEDGER = LEDGERCODE 
	  FROM TRANSACTIONS 
	  WHERE TRANGRP=@IPLTRANGRP AND LEDGERCODE NOT IN (SELECT LEDGERCODE FROM #IPLA) AND (CREDIT-DEBIT)  = @LOANAMOUNT  
	  AND LEDGERCODE NOT IN (@WIP,@RETAINED)

	  INSERT INTO #DISTRIBUTION(TRANGRP,TRANSTYPE,FROMORG,FROMLEDGER,TRANSDATE,FROMAMOUNT,TOORG,TOLEDGER,TOSUBLEDGER,TOAMOUNT,NARRATION,BATCHREF,TRANSREF) 
	  VALUES (@IPLTRANGRP,@TRANSTYPE,@REFERNCESITEID,@FROMLEDGER,@TRANSDATE,@LOANAMOUNT,@TOORG,@TOLEDGER,@SUBLEDGER,@LOANAMOUNT,@NARRATION,@BATCHREF,@TRANSREF  )
  
   END 

  FETCH NEXT FROM IPLATRANGRP INTO @IPLTRANGRP 

END
CLOSE IPLATRANGRP
DEALLOCATE IPLATRANGRP


-- SPLIT ENTRIES 
SELECT TRANGRP FROM #SPLITENTRIES
DECLARE IPLATRANGRP CURSOR FOR SELECT TRANGRP FROM #SPLITENTRIES 

OPEN IPLATRANGRP

FETCH NEXT FROM IPLATRANGRP INTO @IPLTRANGRP 

WHILE @@FETCH_STATUS = 0
BEGIN
    DELETE FROM #SPLITSECTION 

    INSERT INTO #SPLITSECTION
	SELECT   TRANSID,LEDGERCODE,DEBIT,CREDIT,ORGID  
	FROM TRANSACTIONS WHERE TRANGRP = @IPLTRANGRP AND LEDGERCODE NOT IN (SELECT LEDGERCODE FROM #IPLA) AND LEDGERCODE NOT IN (@WIP,@RETAINED) 
	
	SELECT 
		@FROMLEDGER = LEDGERCODE, 
		@SUBLEDGER=CREDNO ,
		@TRANSTYPE = LEFT(BATCHREF,3),
		@LOANAMOUNT = (CREDIT-DEBIT) ,
		@NARRATION = LEFT(DESCRIPTION,200) ,
		@TRANSDATE = PDATE,
		@BATCHREF = BATCHREF,
		@TRANSREF = TRANSREFEXT 
	  FROM 
		TRANSACTIONS 
	  WHERE 
		TRANGRP=@IPLTRANGRP AND  ForeignDescription<>''
 

	  DELETE FROM #SPLITVALUES
	  INSERT INTO  #SPLITVALUES 
	  SELECT TRANSID,CREDIT,SPACE(10),0   FROM TRANSACTIONS WHERE TRANGRP = @IPLTRANGRP AND LEDGERCODE = @REFERENCESITEIPLA
	
	  UPDATE #SPLITVALUES SET OPPLEDGER = LEDGERCODE,TOORG=ORGID   FROM #SPLITSECTION INNER JOIN  
	  #SPLITVALUES ON #SPLITVALUES.CREDIT = #SPLITSECTION.DEBIT
	  AND #SPLITVALUES.TRANSID > #SPLITSECTION.TRANSID 
	  
	   


	  INSERT INTO #DISTRIBUTION(TRANGRP,TRANSTYPE,FROMORG,FROMLEDGER,TRANSDATE,FROMAMOUNT,TOORG,TOLEDGER,TOSUBLEDGER,TOAMOUNT,NARRATION,BATCHREF,TRANSREF) 
	  SELECT @IPLTRANGRP,@TRANSTYPE,@REFERNCESITEID,@FROMLEDGER,@TRANSDATE,@LOANAMOUNT,TOORG,OPPLEDGER,@SUBLEDGER,CREDIT,@NARRATION,@BATCHREF,@TRANSREF  
	  FROM #SPLITVALUES

	 

	  FETCH NEXT FROM IPLATRANGRP INTO @IPLTRANGRP 
END

CLOSE IPLATRANGRP
DEALLOCATE IPLATRANGRP


ALTER TABLE  #DISTRIBUTION ADD FROMLEDGERNAME VARCHAR(200)
ALTER TABLE  #DISTRIBUTION ADD TOLEDGERNAME   VARCHAR(200)
UPDATE #DISTRIBUTION SET FROMLEDGERNAME = L.LEDGERNAME FROM LEDGERCODES L INNER JOIN #DISTRIBUTION ON #DISTRIBUTION.FROMLEDGER = L.LEDGERCODE 
UPDATE #DISTRIBUTION SET TOLEDGERNAME = L.LEDGERNAME FROM LEDGERCODES L INNER JOIN #DISTRIBUTION ON #DISTRIBUTION.TOLEDGER = L.LEDGERCODE

SELECT * FROM #DISTRIBUTION