/****** Object:  Procedure [BI].[spGSTSupplier]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE  BI.spGSTSupplier(@FINYEAR INT,@FROMPERIOD INT,@TOPERIOD INT,@BORGS ListOrgIDS ReadOnly,@LEDGERCODE VARCHAR(15)  )
AS

DECLARE  @LEDGERNAME VARCHAR(50)


CREATE TABLE #BORGS(ORGID INT)
INSERT INTO #BORGS 
SELECT ORGID  FROM @BORGS
DELETE FROM #BORGS WHERE ORGID IS NULL


SELECT 
  ORGID,
  YEAR,
  PERIOD,
  CREDNO,
  SUM(DEBIT) DEBIT,
  SUM(CREDIT) CREDIT 
INTO #TEMP0 
FROM 
  TRANSACTIONS 
WHERE 
  YEAR = @FINYEAR  AND
  PERIOD BETWEEN @FROMPERIOD AND @TOPERIOD AND
  ORGID  IN (SELECT ORGID FROM #BORGS) AND 
  LEDGERCODE = @LEDGERCODE 
GROUP BY 
  YEAR, PERIOD, ORGID, CREDNO 

ALTER TABLE #TEMP0 ADD BORGNAME VARCHAR(150)
ALTER TABLE #TEMP0 ADD SUPPLIERNAME VARCHAR(100)
ALTER TABLE #TEMP0 ADD SUPPLIERCITY VARCHAR(10)
ALTER TABLE #TEMP0 ADD SUPPLIERCITYNAME VARCHAR(100)
ALTER TABLE #TEMP0 ADD SUPPLIERGSTN VARCHAR(25) 
ALTER TABLE #TEMP0 ADD CILGSTIN VARCHAR(25) 
ALTER TABLE #TEMP0 ADD PERIODNAME VARCHAR(25) 
ALTER TABLE #TEMP0 ADD LEDGERCODE VARCHAR(10)
ALTER TABLE #TEMP0 ADD LEDGERNAME VARCHAR(150) 


SELECT @LEDGERNAME = LEDGERNAME FROM LEDGERCODES WHERE LEDGERCODE = @LEDGERCODE 

UPDATE #TEMP0 SET PERIODNAME = PERIODMASTER.PERIODDESC FROM PERIODMASTER INNER JOIN #TEMP0 ON #TEMP0.Period = PERIODMASTER.PERIODID 

UPDATE #TEMP0 SET SUPPLIERCITY =LTRIM(RTRIM(STR(C.PROVINCEID))), SUPPLIERGSTN=C.ISOCERTIFICATION,SUPPLIERNAME=UPPER(C.CREDNAME)
FROM CREDITORS C INNER JOIN #TEMP0 BIP ON BIP.CREDNO=C.CREDNUMBER 
UPDATE #TEMP0 SET SUPPLIERCITY =LTRIM(RTRIM(STR(S.PROVINCEID))), SUPPLIERGSTN=S.ISOCERTIFICATION,SUPPLIERNAME=UPPER(S.SUBNAME)
FROM SUBCONTRACTORS  S INNER JOIN #TEMP0 BIP ON BIP.CREDNO=S.SUBNUMBER 
UPDATE #TEMP0 SET SUPPLIERCITY = UPPER(BIS.SHORTNAME) FROM BI.STATES BIS INNER JOIN #TEMP0 BIP ON BIP.SUPPLIERCITY =BIS.PROVINCEID 
UPDATE #TEMP0 SET SUPPLIERCITY =LTRIM(RTRIM(STR(D.PROVINCEID))), SUPPLIERGSTN=D.ISOCERTIFICATION,SUPPLIERNAME=UPPER(D.DEBTNAME)
FROM DEBTORS D INNER JOIN #TEMP0 BIP ON BIP.CREDNO=D.DEBTNUMBER 
UPDATE #TEMP0 SET SUPPLIERCITYNAME = UPPER(BIS.STATENAME) FROM BI.STATES BIS INNER JOIN #TEMP0 BIP ON BIP.SUPPLIERCITY=BIS.SHORTNAME
UPDATE #TEMP0 SET LEDGERCODE = @LEDGERCODE , LEDGERNAME = @LEDGERNAME 
UPDATE #TEMP0 SET BORGNAME =B.BORGNAME FROM BORGS B INNER JOIN #TEMP0 ON #TEMP0.ORGID = B.BORGID 
UPDATE #TEMP0 SET BORGNAME = B.BORGNAME , CILGSTIN = B.COMPREG FROM BORGS B INNER JOIN #TEMP0 BIP ON BIP.ORGID=B.BORGID 

SELECT YEAR,PERIODNAME,BORGNAME,CILGSTIN,CREDNO,SUPPLIERNAME,SUPPLIERGSTN,SUPPLIERCITY, DEBIT,CREDIT,LEDGERCODE,LEDGERNAME   FROM #TEMP0 ORDER BY YEAR,PERIOD,ORGID,CREDNO 