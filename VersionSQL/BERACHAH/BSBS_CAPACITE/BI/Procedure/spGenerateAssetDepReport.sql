/****** Object:  Procedure [BI].[spGenerateAssetDepReport]    Committed by VersionSQL https://www.versionsql.com ******/

--SELECT * FROM BI.ASSETREPORT 
 -- BI.spGenerateAssetDepReport 2017
CREATE PROCEDURE [BI].[spGenerateAssetDepReport](@FINYEAR INT,@TOPERIOD INT,@REPORTYPE INT )
AS
UPDATE ASSETS SET ASSETCATEGORY='FORMWORK'  WHERE ASSETCATEGORY='Form Work Equipment'   
-- LATEST REPORT 
DECLARE @STARTDATE DATETIME
DECLARE @ENDDATE   DATETIME
DECLARE @PERIODENDDATE DATETIME 

DECLARE @DATESTRING VARCHAR(50)
SET @DATESTRING ='01/04/'+LTRIM(RTRIM(@FINYEAR-1)) 
SELECT @STARTDATE = CONVERT(DATE,@DATESTRING,103)
SET @DATESTRING ='31/03/'+LTRIM(RTRIM(@FINYEAR)) 
SELECT @ENDDATE = CONVERT(DATE,@DATESTRING,103)

SELECT @PERIODENDDATE = PEDATE FROM PERIODSETUP WHERE  YEAR=@FINYEAR AND PERIOD=@TOPERIOD AND ORGID=2

 


DELETE FROM BI.ASSETREPORT 
DBCC CHECKIDENT ( "[BI].[ASSETREPORT]",RESEED,0) 

 
 

  INSERT INTO BI.ASSETREPORT (LIVESTATUS,ASSETCATEGORY,ASSETID,ASSETNUMBER,ASSETNAME,PUTINUSE,PURCHASE_VALUE,ADDITIONS_VALUE,DELETE_VALUE,SALVAGE_VALUE,ASSETMAXLIFE,MONTHLYDEP,CLOSINGLIFE,ADDITIONS_DEP,DELETIONS_DEP,BOOKVALUE,LOCATION)
                     SELECT 'LIVE',AssetCategory,ASSETID,ASSETNUMBER,ASSETNAME,ASSETPDATE,ASSETPPRICE,0,0,ASSETSALVAGE,AssetPeriod,LASTDepTM,ASSETDEPPROG,0,0,AssetBookValue,AssetLocation 
			 FROM ASSETS 
			 WHERE ASSETPDATE < @STARTDATE 

-- ZERO PERIOD 
IF @TOPERIOD<>0
BEGIN
  INSERT INTO BI.ASSETREPORT (LIVESTATUS,ASSETCATEGORY,ASSETID,ASSETNUMBER,ASSETNAME,PUTINUSE,PURCHASE_VALUE,ADDITIONS_VALUE,DELETE_VALUE,SALVAGE_VALUE,ASSETMAXLIFE,MONTHLYDEP,CLOSINGLIFE,ADDITIONS_DEP,DELETIONS_DEP,BOOKVALUE,LOCATION)
                     SELECT 'LIVE',AssetCategory,ASSETID,ASSETNUMBER,ASSETNAME,ASSETPDATE,0,ASSETPPRICE,0,ASSETSALVAGE,AssetPeriod,LASTDepTM,ASSETDEPPROG,0,0,AssetBookValue,AssetLocation 
			 FROM ASSETS 
			 WHERE ASSETPDATE BETWEEN  @STARTDATE AND @PERIODENDDATE 

END 
 -- CONSIDERING PREVIOUS YEARS DELETIONS AND THIS DELETION VALUE MUST BE REDUCED FROM OPENING VALUE 

 SELECT  
	  ASSETID,SUM(ASSETPPRICE) DELETIONS
	  INTO #LASTYEARDELETE
      FROM ASSETS 
	  WHERE ASSETID IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE   YEAR<@FINYEAR AND DEPTYPE='Sale') 
	  GROUP BY ASSETID

 UPDATE BI.ASSETREPORT SET PURCHASE_VALUE = PURCHASE_VALUE - D.DELETIONS FROM #LASTYEARDELETE D INNER JOIN BI.ASSETREPORT ON BI.ASSETREPORT.ASSETID=D.ASSETID 

 

--UPDATE [BI].[ASSETREPORT] 
--  SET OPENINGLIFE = HI.DEPCOUNT, ACCUMULATED_DEP = HI.DEPAMOUNT 
--  FROM  BI.ACCUMDEPHISTORY HI   INNER JOIN [BI].[ASSETREPORT] RP
--  ON RP.ASSETID = HI.ASSETID 

UPDATE BI.ASSETREPORT SET ACCUMULATED_DEP = 0.0
UPDATE BI.ASSETREPORT SET PURCHASE_VALUE = 0 WHERE PURCHASE_VALUE IS NULL

UPDATE BI.ASSETREPORT
  SET OPENINGLIFE = HI.CURRNETCOUNT, ACCUMULATED_DEP = HI.DEBIT  
  FROM  BI.ASSETPOSTS HI   INNER JOIN [BI].[ASSETREPORT] RP
  ON RP.ASSETID = HI.ASSETID WHERE HI.[YEAR]=@FINYEAR AND HI.PERIOD=0 

  --SELECT SUM(ACCUMULATED_DEP) FROM BI.ASSETREPORT
  --SELECT SUM(DEBIT) FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=0 


UPDATE BI.ASSETREPORT SET APRIL=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #APRIL FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=1 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 1 ) 
GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET APRIL=PO.DEBIT FROM #APRIL PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  

 
 				 
UPDATE BI.ASSETREPORT SET MAY=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #MAY FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=2 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 2 ) 
GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET MAY=PO.DEBIT FROM #MAY PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  

UPDATE BI.ASSETREPORT SET JUNE=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #JUNE FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=3 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 3 ) 
GROUP BY ASSETID 


UPDATE BI.ASSETREPORT 
 SET JUNE=PO.DEBIT FROM #JUNE  PO LEFT OUTER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  

UPDATE BI.ASSETREPORT SET JULY=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #JULY FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=4 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 4 ) 
GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET JULY=PO.DEBIT FROM #JULY PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  

UPDATE BI.ASSETREPORT SET AUGUST=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #AUGUST FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=5 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 5 ) 
GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET AUGUST=PO.DEBIT FROM #AUGUST PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  
 
UPDATE BI.ASSETREPORT SET SEPTEMBER=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #SEPT FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=6 AND DEPTYPE<>'SALE'
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 6 ) 
 GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET SEPTEMBER=PO.DEBIT FROM #SEPT PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  

UPDATE BI.ASSETREPORT SET OCTOBER=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #OCT FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=7 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 7 ) 
GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET OCTOBER=PO.DEBIT FROM #OCT PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  
  
UPDATE BI.ASSETREPORT SET NOVEMBER =0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #NOV FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=8 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 8 ) 
GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET NOVEMBER=PO.DEBIT FROM #NOV PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  

UPDATE BI.ASSETREPORT SET DECEMBER=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #DEC FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=9 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 9 ) 
GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET DECEMBER=PO.DEBIT FROM #DEC PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  
 
UPDATE BI.ASSETREPORT SET JANUARY=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #JAN FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=10 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 10 ) 
GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET JANUARY=PO.DEBIT FROM #JAN PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  

UPDATE BI.ASSETREPORT SET FEBRUARY=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #FEB FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=11 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 11 ) 
GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET FEBRUARY=PO.DEBIT FROM #FEB PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  

UPDATE BI.ASSETREPORT SET MARCH=0
SELECT ASSETID,SUM(DEBIT) DEBIT INTO #MAR FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR AND PERIOD=12 AND DEPTYPE<>'SALE' 
--AND ASSETID NOT IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE' AND YEAR=@FINYEAR AND PERIOD= 12 ) 
GROUP BY ASSETID 
UPDATE BI.ASSETREPORT 
 SET MARCH=PO.DEBIT FROM #MAR PO INNER JOIN BI.ASSETREPORT RP ON RP.ASSETID=PO.ASSETID  


  

IF @TOPERIOD = 0
   UPDATE BI.ASSETREPORT SET APRIL=0,MAY=0,JUNE=0,JULY=0,AUGUST=0,SEPTEMBER=0,OCTOBER=0,NOVEMBER=0,DECEMBER = 0,JANUARY=0,FEBRUARY=0,MARCH=0

IF @TOPERIOD = 1
   UPDATE BI.ASSETREPORT SET MAY=0,JUNE=0,JULY=0,AUGUST=0,SEPTEMBER=0,OCTOBER=0,NOVEMBER=0,DECEMBER = 0,JANUARY=0,FEBRUARY=0,MARCH=0

IF @TOPERIOD = 2
   UPDATE BI.ASSETREPORT SET JUNE=0,JULY=0,AUGUST=0,SEPTEMBER=0,OCTOBER=0,NOVEMBER=0,DECEMBER = 0,JANUARY=0,FEBRUARY=0,MARCH=0

IF @TOPERIOD = 3
   UPDATE BI.ASSETREPORT SET JULY=0,AUGUST=0,SEPTEMBER=0,OCTOBER=0,NOVEMBER=0,DECEMBER = 0,JANUARY=0,FEBRUARY=0,MARCH=0

IF @TOPERIOD = 4
   UPDATE BI.ASSETREPORT SET AUGUST=0,SEPTEMBER=0,OCTOBER=0,NOVEMBER=0,DECEMBER = 0,JANUARY=0,FEBRUARY=0,MARCH=0

IF @TOPERIOD = 5
   UPDATE BI.ASSETREPORT SET SEPTEMBER=0,OCTOBER=0,NOVEMBER=0,DECEMBER = 0,JANUARY=0,FEBRUARY=0,MARCH=0

IF @TOPERIOD = 6
   UPDATE BI.ASSETREPORT SET OCTOBER=0,NOVEMBER=0,DECEMBER = 0,JANUARY=0,FEBRUARY=0,MARCH=0

IF @TOPERIOD = 7
   UPDATE BI.ASSETREPORT SET NOVEMBER=0,DECEMBER = 0,JANUARY=0,FEBRUARY=0,MARCH=0

IF @TOPERIOD = 8
   UPDATE BI.ASSETREPORT SET DECEMBER =0,JANUARY=0,FEBRUARY=0,MARCH=0

IF @TOPERIOD = 9
   UPDATE BI.ASSETREPORT SET JANUARY=0,FEBRUARY=0,MARCH=0

IF @TOPERIOD = 10
   UPDATE BI.ASSETREPORT SET FEBRUARY=0,MARCH=0

IF @TOPERIOD = 11
   UPDATE BI.ASSETREPORT SET MARCH=0

IF @TOPERIOD = 11
   UPDATE BI.ASSETREPORT SET MARCH=0




SELECT DISTINCT COLKEY AS ASSETID  
INTO #TEMPATTRIBUTE
FROM ATTRIBVALUE WHERE TABLENAME='ASSETS'

ALTER TABLE #TEMPATTRIBUTE ADD DUTYBENEFITS DECIMAL(18,2)
ALTER TABLE #TEMPATTRIBUTE ADD FEREVALUATION DECIMAL(18,2)
ALTER TABLE #TEMPATTRIBUTE ADD INVOICENO     VARCHAR(15)
ALTER TABLE #TEMPATTRIBUTE ADD GRN VARCHAR(25) 
ALTER TABLE #TEMPATTRIBUTE ADD ORDID INT 
ALTER TABLE #TEMPATTRIBUTE ADD INVOICEAMOUNT DECIMAL(18,2)
ALTER TABLE #TEMPATTRIBUTE ADD INVOICEDATE DATETIME
ALTER TABLE #TEMPATTRIBUTE ADD ORDERTYPE INT
ALTER TABLE #TEMPATTRIBUTE ADD TAXAMOUNT DECIMAL(18,2)
ALTER TABLE #TEMPATTRIBUTE ADD SUPPLIERNAME VARCHAR(200)
ALTER TABLE #TEMPATTRIBUTE ADD SUPPLIERCODE VARCHAR(15)
ALTER TABLE #TEMPATTRIBUTE ADD PONUMBER VARCHAR(50)
ALTER TABLE #TEMPATTRIBUTE ADD PODATE DATETIME
 

UPDATE #TEMPATTRIBUTE SET DUTYBENEFITS=VALUE FROM ATTRIBVALUE INNER JOIN #TEMPATTRIBUTE ON #TEMPATTRIBUTE.ASSETID = ATTRIBVALUE.COLKEY 
WHERE ATTRIBVALUE.ATTRIBUTE='DUTYBENEFITS'
UPDATE #TEMPATTRIBUTE SET FEREVALUATION=VALUE FROM ATTRIBVALUE INNER JOIN #TEMPATTRIBUTE ON #TEMPATTRIBUTE.ASSETID = ATTRIBVALUE.COLKEY 
WHERE ATTRIBVALUE.ATTRIBUTE='FEREVALUATION'
UPDATE #TEMPATTRIBUTE SET INVOICENO=VALUE FROM ATTRIBVALUE INNER JOIN #TEMPATTRIBUTE ON #TEMPATTRIBUTE.ASSETID = ATTRIBVALUE.COLKEY
WHERE ATTRIBVALUE.ATTRIBUTE='INVOICENO'
UPDATE #TEMPATTRIBUTE SET GRN=VALUE FROM ATTRIBVALUE INNER JOIN #TEMPATTRIBUTE ON #TEMPATTRIBUTE.ASSETID = ATTRIBVALUE.COLKEY
WHERE ATTRIBVALUE.ATTRIBUTE='GRN'
UPDATE #TEMPATTRIBUTE SET ORDID=VALUE FROM ATTRIBVALUE INNER JOIN #TEMPATTRIBUTE ON #TEMPATTRIBUTE.ASSETID = ATTRIBVALUE.COLKEY
WHERE ATTRIBVALUE.ATTRIBUTE='ORDID'

UPDATE #TEMPATTRIBUTE SET PODATE = O.CREATEDATE,PONUMBER = O.ORDNUMBER,SUPPLIERCODE=SUPPID  FROM ORD O INNER JOIN #TEMPATTRIBUTE ON O.ORDID=#TEMPATTRIBUTE.ORDID 
UPDATE #TEMPATTRIBUTE SET SUPPLIERCODE = S.SUPPCODE, SUPPLIERNAME=S.SUPPNAME FROM SUPPLIERS S INNER JOIN #TEMPATTRIBUTE ON #TEMPATTRIBUTE.SUPPLIERCODE=S.SUPPID 

UPDATE #TEMPATTRIBUTE SET INVOICEAMOUNT=T.CREDIT , INVOICEDATE= T.PDATE FROM TRANSACTIONS T INNER JOIN #TEMPATTRIBUTE ON 
T.TRANSREF=#TEMPATTRIBUTE.INVOICENO AND T.ORDERNO=#TEMPATTRIBUTE.PONUMBER WHERE T.LEDGERCODE='1315000' 


DECLARE @VATSTART VARCHAR(10)
DECLARE @VATEND VARCHAR(10)
SELECT @VATSTART = CONTROLFROMGL FROM CONTROLCODES WHERE CONTROLNAME='Value Added Tax' 
SELECT @VATEND = CONTROLTOGL FROM CONTROLCODES WHERE CONTROLNAME='Value Added Tax' 

SELECT ORDERNO,SUM(DEBIT) TAXSUM  INTO #TAXSUMS FROM TRANSACTIONS WHERE LEDGERCODE BETWEEN @VATSTART AND @VATEND AND ORDERNO IN (SELECT PONUMBER FROM #TEMPATTRIBUTE) GROUP BY ORDERNO 

UPDATE #TEMPATTRIBUTE SET TAXAMOUNT = T.TAXSUM FROM #TAXSUMS T INNER JOIN #TEMPATTRIBUTE ON #TEMPATTRIBUTE.PONUMBER = T.ORDERNO 


UPDATE BI.ASSETREPORT SET ASSETNAME=UPPER(ASSETNAME),ASSETCATEGORY=UPPER(ASSETCATEGORY) 


INSERT INTO BI.ASSETREPORT (LIVESTATUS,ASSETCATEGORY,ASSETID,ASSETNUMBER,ASSETNAME,PUTINUSE,PURCHASE_VALUE,ADDITIONS_VALUE,DELETE_VALUE,SALVAGE_VALUE,ASSETMAXLIFE,MONTHLYDEP,CLOSINGLIFE,ADDITIONS_DEP,DELETIONS_DEP, BOOKVALUE,LOCATION,SALEDATE,SALEVALUE,ACCUMULATED_DEP)
                     SELECT 'DELETE',AssetCategory,ASSETID,ASSETNUMBER,ASSETNAME,ASSETISDATE,0,0,-1.0* ASSETPPRICE,-1.0 * ASSETSALVAGE,AssetPeriod,LASTDepTM,ASSETDEPPROG,0,0,-1.0* AssetBookValue,AssetLocation,ASSETISDATE,ASSETSALE,-1.0*AssetAccumDep FROM ASSETS 
					 WHERE ASSETID IN (SELECT ASSETID FROM BI.ASSETPOSTS WHERE DEPTYPE='SALE'   AND YEAR=@FINYEAR AND PERIOD <=@TOPERIOD ) 


SELECT ASSETID,SUM(DEBIT) DEPADDS 
	INTO #TEMPADDS 
	FROM BI.ASSETPOSTS WHERE YEAR=@FINYEAR   
	AND ASSETID IN (SELECT ASSETID FROM BI.ASSETREPORT WHERE ADDITIONS_VALUE >0)
	GROUP BY ASSETID 

--UPDATE BI.ASSETREPORT SET ADDITIONS_DEP = T.DEPADDS FROM #TEMPADDS T INNER JOIN BI.ASSETREPORT ON BI.ASSETREPORT.ASSETID=T.ASSETID 
--WHERE BI.ASSETREPORT.ADDITIONS_VALUE >0

UPDATE BI.ASSETREPORT SET ADDITIONS_DEP = 0

UPDATE BI.ASSETREPORT SET ADDITIONS_DEP = APRIL+MAY+JUNE+JULY+AUGUST+SEPTEMBER+OCTOBER+NOVEMBER+DECEMBER+JANUARY+FEBRUARY+MARCH
 


 

SELECT 	  ASSETID ,SUM(DEBIT) SUMDELETEDEP 
INTO #TEMPDEL
FROM BI.ASSETPOSTS
WHERE   YEAR=@FINYEAR  AND DEPTYPE='Sale'       GROUP BY ASSETID  

UPDATE BI.ASSETREPORT SET DELETIONS_DEP = T.SUMDELETEDEP FROM #TEMPDEL T INNER JOIN BI.ASSETREPORT ON BI.ASSETREPORT.ASSETID=T.ASSETID 
WHERE BI.ASSETREPORT.DELETE_VALUE <0 


UPDATE BI.ASSETREPORT SET ACCUMULATED_DEP = 0 WHERE LIVESTATUS<>'LIVE'

UPDATE BI.ASSETREPORT SET BOOKVALUE=0.0

UPDATE BI.ASSETREPORT SET APRIL = 0.0 WHERE APRIL IS NULL
UPDATE BI.ASSETREPORT SET MAY = 0.0 WHERE MAY IS NULL
UPDATE BI.ASSETREPORT SET JUNE = 0.0 WHERE JUNE IS NULL
UPDATE BI.ASSETREPORT SET JULY = 0.0 WHERE JULY IS NULL
UPDATE BI.ASSETREPORT SET AUGUST = 0.0 WHERE AUGUST IS NULL
UPDATE BI.ASSETREPORT SET SEPTEMBER = 0.0 WHERE SEPTEMBER IS NULL
UPDATE BI.ASSETREPORT SET OCTOBER = 0.0 WHERE OCTOBER IS NULL
UPDATE BI.ASSETREPORT SET NOVEMBER = 0.0 WHERE NOVEMBER IS NULL
UPDATE BI.ASSETREPORT SET DECEMBER = 0.0 WHERE DECEMBER IS NULL
UPDATE BI.ASSETREPORT SET JANUARY = 0.0 WHERE JANUARY IS NULL
UPDATE BI.ASSETREPORT SET FEBRUARY = 0.0 WHERE FEBRUARY IS NULL
UPDATE BI.ASSETREPORT SET MARCH = 0.0 WHERE MARCH IS NULL

UPDATE BI.ASSETREPORT SET ADDITIONS_DEP = 0.0 WHERE ADDITIONS_DEP IS NULL

UPDATE BI.ASSETREPORT SET DELETIONS_DEP = 0.0 WHERE DELETIONS_DEP IS NULL

UPDATE BI.ASSETREPORT SET ACCUMULATED_DEP = 0.0 WHERE ACCUMULATED_DEP IS NULL

UPDATE BI.ASSETREPORT SET PURCHASE_VALUE = 0.0 WHERE PURCHASE_VALUE IS NULL

UPDATE BI.ASSETREPORT SET ADDITIONS_VALUE = 0.0 WHERE ADDITIONS_VALUE IS NULL

UPDATE BI.ASSETREPORT SET DELETE_VALUE = 0.0 WHERE DELETE_VALUE IS NULL



UPDATE BI.ASSETREPORT SET BOOKVALUE = 0.0

UPDATE BI.ASSETREPORT SET BOOKVALUE = PURCHASE_VALUE+ADDITIONS_VALUE+DELETE_VALUE-(ACCUMULATED_DEP+ADDITIONS_DEP+DELETIONS_DEP) 

 


SELECT BIA.ASSETCATEGORY,BIA.ASSETNUMBER,BIA.ASSETNAME,BIA.PUTINUSE,BIA.PURCHASE_VALUE AS ASSETVALUE,BIA.ADDITIONS_VALUE AS ADDITIONS,
        BIA.DELETE_VALUE DELETIONS,BIA.SALVAGE_VALUE AS SALVAGE, BIA.ASSETMAXLIFE,BIA.OPENINGLIFE,BIA.ACCUMULATED_DEP AS ACCUMDEP,
       BIA.APRIL,BIA.MAY,BIA.JUNE,BIA.JULY,BIA.AUGUST,BIA.SEPTEMBER,BIA.OCTOBER,BIA.NOVEMBER,BIA.DECEMBER,BIA.JANUARY,
	   BIA.FEBRUARY,BIA.MARCH,(BIA.ASSETMAXLIFE-BIA.CLOSINGLIFE) REMAININGLIFE,BIA.ADDITIONS_DEP DEPADDITIONS,
	   BIA.DELETIONS_DEP DEPDELETES,BIA.BOOKVALUE BOOKVALUE,BIA.LOCATION ,AT.DUTYBENEFITS,
	   AT.FEREVALUATION,AT.INVOICENO,AT.INVOICEAMOUNT,AT.GRN,AT.SUPPLIERNAME,AT.SUPPLIERCODE,AT.PONUMBER,
	   AT.PODATE,BIA.SALEDATE,BIA.SALEVALUE ,BIA.ASSETID,BIA.LIVESTATUS
INTO #TEMPASSETREPORT
FROM BI.ASSETREPORT AS BIA LEFT OUTER  JOIN #TEMPATTRIBUTE AT 
ON BIA.ASSETID = AT.ASSETID 

 
 
SELECT ASSETCATEGORY , SUM(ASSETVALUE) OPENING, SUM(ADDITIONS) ADDITIONS, 
                       SUM(DELETIONS) DELETIONS, SUM(ACCUMDEP) OPENIGDEP,
					   SUM(DEPADDITIONS) ADDITIONSDEP,SUM(DEPDELETES) DELETIONSDEP 
					   INTO #TEMPASSETREPORTSUMMARY 
					   FROM #TEMPASSETREPORT 
					   GROUP BY ASSETCATEGORY

ALTER TABLE #TEMPASSETREPORTSUMMARY ADD LEDGERCODE VARCHAR(15) 
ALTER TABLE #TEMPASSETREPORTSUMMARY ADD LEDGERNAME VARCHAR(50)
ALTER TABLE #TEMPASSETREPORTSUMMARY ADD CLOSING DECIMAL(18,2) 
ALTER TABLE #TEMPASSETREPORTSUMMARY ADD CLOSINGDEP DECIMAL(18,2) 
ALTER TABLE #TEMPASSETREPORTSUMMARY ADD NETVALUE DECIMAL(18,2) 
ALTER TABLE #TEMPASSETREPORTSUMMARY ADD STARTDATE DATETIME 
ALTER TABLE #TEMPASSETREPORTSUMMARY ADD ENDDATE DATETIME 

 

UPDATE #TEMPASSETREPORTSUMMARY SET LEDGERNAME=''

UPDATE #TEMPASSETREPORTSUMMARY SET LEDGERNAME = 'PLANT AND MACHINERY   ' , LEDGERCODE = '2200001'  WHERE ASSETCATEGORY = 'PLANT AND MACHINERY'
UPDATE #TEMPASSETREPORTSUMMARY SET LEDGERNAME = 'FURNITURE AND FIXTURES' , LEDGERCODE = '2200002'  WHERE ASSETCATEGORY = 'FURNITURE AND FIXTURES'
UPDATE #TEMPASSETREPORTSUMMARY SET LEDGERNAME = 'COMPUTERS AND PRINTERS' , LEDGERCODE = '2200003'  WHERE ASSETCATEGORY = 'COMPUTERS AND PRINTERS'
UPDATE #TEMPASSETREPORTSUMMARY SET LEDGERNAME = 'FORMWORK              ' , LEDGERCODE = '2200004'  WHERE ASSETCATEGORY = 'FORMWORK'
UPDATE #TEMPASSETREPORTSUMMARY SET LEDGERNAME = 'VEHICLES              ' , LEDGERCODE = '2200005'  WHERE ASSETCATEGORY = 'VEHICLES'
UPDATE #TEMPASSETREPORTSUMMARY SET LEDGERNAME = 'OFFICE EQUIPMENTS     ' , LEDGERCODE = '2200006'  WHERE ASSETCATEGORY = 'OFFICE EQUIPMENTS'
UPDATE #TEMPASSETREPORTSUMMARY SET LEDGERNAME = 'BUILDINGS             ' , LEDGERCODE = '2200007'  WHERE ASSETCATEGORY = 'BUILDINGS'
UPDATE #TEMPASSETREPORTSUMMARY SET LEDGERNAME = 'COMPUTER SOFTWARE     ' , LEDGERCODE = '2201000'  WHERE ASSETCATEGORY = 'COMPUTER SOFTWARE'

 

UPDATE #TEMPASSETREPORTSUMMARY SET CLOSING = OPENING+ADDITIONS+DELETIONS
UPDATE #TEMPASSETREPORTSUMMARY SET CLOSINGDEP = OPENIGDEP+ADDITIONSDEP+DELETIONSDEP 
UPDATE #TEMPASSETREPORTSUMMARY SET NETVALUE = CLOSING - CLOSINGDEP 
UPDATE #TEMPASSETREPORTSUMMARY SET STARTDATE = @STARTDATE 
UPDATE #TEMPASSETREPORTSUMMARY SET ENDDATE = @ENDDATE 


 

-- DELETING THE DETAILS WHEN PERIOD=OPENING BALANCE 
IF @TOPERIOD=0  
BEGIN
   UPDATE #TEMPASSETREPORTSUMMARY SET  ADDITIONSDEP=0,DELETIONS=0,DELETIONSDEP=0,CLOSING=0,CLOSINGDEP=0 WHERE ADDITIONS>0
   UPDATE #TEMPASSETREPORTSUMMARY SET  ADDITIONS=0 WHERE ADDITIONS>0

END 

IF @REPORTYPE = 1
 BEGIN
   --SELECT * FROM #TEMPASSETREPORT ORDER BY ASSETCATEGORY,ASSETNUMBER
   SELECT * FROM #TEMPASSETREPORT ORDER BY ASSETCATEGORY,ASSETNUMBER
    


 END 
ELSE
 BEGIN 
   SELECT LEDGERCODE  ,
          LEDGERNAME ,
	      OPENING , 
	      ADDITIONS , 
	      DELETIONS , 
	      CLOSING ,
	      OPENIGDEP  , 
	      ADDITIONSDEP  , 
	      DELETIONSDEP, 
	      CLOSINGDEP ,
	      NETVALUE  ,
	      STARTDATE,
	      ENDDATE   
   FROM   #TEMPASSETREPORTSUMMARY 
   ORDER BY LEDGERCODE
 END 