/****** Object:  Procedure [EI].[extractSubbie]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE EI.extractSubbie
AS

CREATE TABLE #TEMP0(SUBID INT,SUBNUMBER VARCHAR(25), GSTIN VARCHAR(25), NAME VARCHAR(200), ADDRESS1 VARCHAR(200), ADDRESS2 VARCHAR(200), LOCATION VARCHAR(200)) 
INSERT INTO #TEMP0 
SELECT  SUBID,SUBNUMBER,ISOCERTIFICATION,SUBNAME,SUBADDRESS1,SUBADDRESS2,SUBADDRESS3 
FROM SUBCONTRACTORS WHERE SUBID IN (
SELECT DISTINCT SUBCONNUMBER  FROM SUBCRECONS  WHERE YEAR(POSTDATE) IN (2019, 2020)  AND RECONID IN (SELECT  CONTRARECONID FROM CONTRAS) ) 

ALTER TABLE #TEMP0 ADD BORGID INT 
ALTER TABLE #TEMP0 ADD ORDERNO VARCHAR(100)
ALTER TABLE #TEMP0 ADD LOGDATE DATETIME 
 

UPDATE #TEMP0 
 SET BORGID=S.ORGID, ORDERNO=S.ORDERNO, LOGDATE= S.POSTDATE , SUBID = S.SUBCONNUMBER 
 FROM SUBCRECONS S INNER JOIN #TEMP0 ON #TEMP0.SUBID  = S.SUBCONNUMBER 

ALTER TABLE #TEMP0 ADD BORGNAME VARCHAR(200)
UPDATE #TEMP0 SET BORGNAME = B.BORGNAME FROM BORGS B INNER JOIN #TEMP0 ON #TEMP0.BORGID=B.BORGID 

 

SELECT SUBNUMBER,GSTIN,NAME,ADDRESS1,ADDRESS2,LOCATION  FROM 
#TEMP0 
WHERE GSTIN<>''
ORDER BY GSTIN ,NAME 