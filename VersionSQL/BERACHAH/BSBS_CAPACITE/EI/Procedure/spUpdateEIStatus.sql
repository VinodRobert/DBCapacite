/****** Object:  Procedure [EI].[spUpdateEIStatus]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE EI.spUpdateEIStatus
AS
DECLARE @RECONID INT
DECLARE @RECONIDSEARCH VARCHAR(55)
DECLARE @CONTRATHISMONTH DECIMAL(18,2) 
DECLARE @ALREADYIN INT

DECLARE RECONLIST CURSOR FOR SELECT RECONID,CONTRATHISMONTH FROM SUBCRECONS WHERE DATEDIFF(MINUTE,LOGDATETIME,GETDATE())<=60
OPEN RECONLIST
FETCH NEXT FROM RECONLIST INTO @RECONID,@CONTRATHISMONTH

WHILE @@FETCH_STATUS = 0 
BEGIN
 SET @ALREADYIN = 0
 SET @RECONIDSEARCH =LTRIM(RTRIM(STR(@RECONID))) 
 SELECT @ALREADYIN = COUNT(*)  FROM ATTRIBVALUE WHERE COLKEY = @RECONIDSEARCH

 IF @ALREADYIN = 0 
  BEGIN
    IF @CONTRATHISMONTH <> 0 
	    INSERT INTO ATTRIBVALUE(COLKEY,TABLENAME,ATTRIBUTE,VALUE,USERID,LOGDATETIME,ARRAYINDEX) 
		SELECT @RECONID,'SUBCRECONS','EI','OPEN',-1,GETDATE(),0
	ELSE
	    INSERT INTO ATTRIBVALUE(COLKEY,TABLENAME,ATTRIBUTE,VALUE,USERID,LOGDATETIME,ARRAYINDEX) 
    	SELECT @RECONID,'SUBCRECONS','EI','NA',-1,GETDATE(),0
  END
 ELSE
  BEGIN
    IF @CONTRATHISMONTH <> 0 
	    UPDATE ATTRIBVALUE SET VALUE = 'OPEN'  WHERE COLKEY=@RECONID AND TABLENAME='SUBCRECONS' AND ATTRIBUTE='EI' 
	ELSE
	    UPDATE ATTRIBVALUE SET VALUE = 'NA'    WHERE COLKEY=@RECONID AND TABLENAME='SUBCRECONS' AND ATTRIBUTE='EI'
  END	
 FETCH NEXT FROM RECONLIST INTO @RECONID,@CONTRATHISMONTH
END
CLOSE RECONLIST
DEALLOCATE RECONLIST 