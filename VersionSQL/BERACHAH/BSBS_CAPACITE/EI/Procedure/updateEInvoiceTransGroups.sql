/****** Object:  Procedure [EI].[updateEInvoiceTransGroups]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE EI.updateEInvoiceTransGroups
AS
DECLARE @INVOICEID INT
DECLARE @REFID INT 
DECLARE @BORGID INT 
DECLARE @PARTYCODE VARCHAR(15) 
DECLARE @NETINVOICEAMOUNT DECIMAL(18,2) 
DECLARE @LASTTRANGRPID INT 
DECLARE @POSTEDTRANGRP INT
DECLARE @NEWINVOICENUMBER VARCHAR(20)
DECLARE @NEWINVOICEDATE DATETIME 

DECLARE INVOICELIST CURSOR FOR SELECT INVOICEID FROM EI.EINVOICE WHERE TRANSGROUP = -1  ORDER BY INVOICEID DESC
OPEN INVOICELIST 
FETCH NEXT FROM INVOICELIST INTO @INVOICEID 

WHILE @@FETCH_STATUS=0
BEGIN
 
  SELECT @BORGID=BORGID,@PARTYCODE=PARTYCODE FROM EI.EINVOICE WHERE INVOICEID=@INVOICEID 

  IF (LEFT(@PARTYCODE,1)='D') 
   BEGIN
     SELECT @NETINVOICEAMOUNT = INVOICEAMOUNT FROM EI.EINVOICE WHERE INVOICEID=@INVOICEID 
     SELECT @LASTTRANGRPID = TRANGRP_DEBTOR FROM EC.PROJECTS WHERE BSBORGID=@BORGID 
	 
	 SET @POSTEDTRANGRP=0
	 SELECT @POSTEDTRANGRP =  ISNULL(TRANGRP,0) FROM TRANSACTIONS
	    WHERE ORGID=@BORGID AND LEFT(TRANSTYPE,3)='DTI' AND LEDGERCODE='2540000' AND CREDNO=@PARTYCODE AND  DEBIT=@NETINVOICEAMOUNT  AND TRANGRP>@LASTTRANGRPID 
     
	 IF @POSTEDTRANGRP<> 0
	   BEGIN
	     SELECT @NEWINVOICEDATE = INVOICEDATE,@NEWINVOICENUMBER=INVOICENUMBER FROM EI.EINVOICE WHERE INVOICEID=@INVOICEID 
		 BEGIN TRAN
		    UPDATE EI.EINVOICE SET TRANSGROUP = @POSTEDTRANGRP WHERE INVOICEID=@INVOICEID 
			UPDATE EC.PROJECTS SET TRANGRP_DEBTOR =@POSTEDTRANGRP WHERE BSBORGID=@BORGID 
			UPDATE TRANSACTIONS SET TRANSREFEXT=@NEWINVOICENUMBER , RECEIVEDDATE = @NEWINVOICEDATE WHERE TRANGRP = @POSTEDTRANGRP 
		 COMMIT TRAN

	   END
   END

  FETCH NEXT FROM INVOICELIST INTO @INVOICEID 
END
CLOSE INVOICELIST
DEALLOCATE INVOICELIST 