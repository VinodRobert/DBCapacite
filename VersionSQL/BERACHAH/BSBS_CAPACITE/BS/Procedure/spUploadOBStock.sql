/****** Object:  Procedure [BS].[spUploadOBStock]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE [BS].[spUploadOBStock](@STORECODE VARCHAR(10)) 
AS

DECLARE @STORE VARCHAR(10)
DECLARE @STOCKNO VARCHAR(10)
DECLARE @QTY DECIMAL(18,4)
DECLARE @RATE DECIMAL(18,2)
DECLARE @ORGID INT
DECLARE @STORELEDGER VARCHAR(10)
DECLARE @COUNTS INT
DECLARE @DEBIT DECIMAL(18,2) 

DECLARE @OLDRATE DECIMAL(18,2)
DECLARE @OLDQTY  DECIMAL(18,4) 
DECLARE @NEWQTY  DECIMAL(18,4)
DECLARE @NEWRATE DECIMAL(18,4)
DECLARE @ID INT 

UPDATE BS.STOCKUPLOAD  SET QTY=0 WHERE QTY IS NULL
UPDATE BS.STOCKUPLOAD  SET RATE=0 WHERE RATE IS NULL

DELETE  FROM TRANSACTIONS WHERE STORE=@STORECODE AND YEAR=2016 AND TRANSREF= 'OB' AND PERIOD=1

DELETE  FROM BS.STOCKREPORT 
WHERE STORE=@STORECODE AND TRANSTYPE='STW' 

 


DECLARE OBSTK CURSOR 
FOR SELECT STORE,STOCKCODE,QTY,RATE FROM BS.STOCKUPLOAD WHERE STORE=@STORECODE

SELECT 
       [OrgID]
      ,[Year]
      ,[Period]
      ,[PDate]
      ,[BatchRef]
      ,[TransRef]
      ,[MatchRef]
      ,[TransType]
      ,[Allocation]
      ,[LedgerCode]
      ,[Contract]
      ,[Activity]
      ,[Description]
      ,[ForeignDescription]
      ,[Currency]
      ,[Debit]
      ,[Credit]
      ,[VatDebit]
      ,[VatCredit]
      ,[Credno]
      ,[Store]
      ,[Plantno]
      ,[Stockno]
      ,[Quantity]
      ,[Unit]
      ,[Rate]
      ,[ReqNo]
      ,[OrderNo]
      ,[Age]
      ,[SubConTran]
      ,[VATType]
      ,[HomeCurrAmount]
      ,[ConversionDate]
      ,[ConversionRate]
      ,[PaidFor]
      ,[PaidToDate]
      ,[PaidThisPeriod]
      ,[WhtThisPeriod]
      ,[DiscThisPeriod]
      ,[ReconStatus]
      ,[UserID]
      ,[DivID]
      ,[ForexVal]
      ,[HeadID]
      ,[XGLCODE]
      ,[XVATA]
      ,[XVATT]
      ,[DOCNUMBER]
      ,[WHTID]
      ,[FBID]
      ,[TERM]
      ,[SYSDATE]
      ,[RECEIVEDDATE]
      ,[ORIGTRANSID]
      ,[HCTODATE]
      ,[TRANGRP]
INTO #TEMP 
FROM TRANSACTIONS WHERE  TRANSID = 913171

SELECT * INTO #TEMPUPLOAD FROM #TEMP WHERE 1=2 

OPEN OBSTK
FETCH NEXT FROM OBSTK INTO @STORE,@STOCKNO,@QTY,@RATE

WHILE @@FETCH_STATUS = 0
BEGIN
  SELECT @COUNTS = COUNT(*) FROM TRANSACTIONS 
  WHERE YEAR=2016 AND STOCKNO=@STOCKNO AND STORE =@STORE AND TRANSREF='OB' AND TRANSTYPE='STW'
  
  IF @COUNTS=0 
  BEGIN
     SELECT @STORELEDGER=STKCTL   FROM INVSTORES WHERE STORECODE= @STORE
	 SELECT @ORGID = BORGID  FROM INVENTORY WHERE STKSTORE=@STORE
	 SELECT @DEBIT=  @QTY*@RATE 
	 IF @DEBIT>0 
	 BEGIN
	  UPDATE #TEMP  
	  SET ORGID=@ORGID,
	      LEDGERCODE=@STORELEDGER,
		  DEBIT=@DEBIT,
		  STORE=@STORE,
		  STOCKNO=@STOCKNO,
		  QUANTITY = @QTY,
		  RATE = @RATE, 
		  FBID = -1 ,
		  TRANSREF='OB' ,
		  TRANSTYPE='STW',
		  YEAR = 2016,
		  PERIOD=1,
		  PDATE = '01-APR-2015',
		  DESCRIPTION = 'Opening Stock as on 01 April 2015'
	 END
	 INSERT INTO #TEMPUPLOAD SELECT * FROM #TEMP WHERE DEBIT>0
  END
  FETCH NEXT FROM OBSTK INTO @STORE,@STOCKNO,@QTY,@RATE


END
CLOSE OBSTK
DEALLOCATE OBSTK 

DECLARE @TRANGRP INT
SELECT @TRANGRP = MAX(TRANGRP) FROM TRANSACTIONS 
SET @TRANGRP=@TRANGRP+1
UPDATE #TEMPUPLOAD SET TRANGRP=@TRANGRP 

SELECT * FROM #TEMPUPLOAD 

INSERT INTO TRANSACTIONS 
SELECT * FROM #TEMPUPLOAD

 

 
 

 
DECLARE CHANGEINV CURSOR 
FOR SELECT STORE,STOCKCODE,QTY,RATE FROM BS.STOCKUPLOAD WHERE STORE=@STORECODE

OPEN CHANGEINV
FETCH NEXT FROM CHANGEINV INTO @STORE,@STOCKNO,@QTY,@RATE

WHILE @@FETCH_STATUS = 0
BEGIN
    SELECT @OLDRATE = STKCOSTRATE , @OLDQTY = STKQUANTITY , @ID = STKID  FROM INVENTORY WHERE STKCODE=@STOCKNO AND STKSTORE=@STORE 
	SET @NEWRATE = ( (@OLDRATE * @OLDQTY ) + (@RATE * @QTY ) ) / (@QTY + @OLDQTY)
	SET @NEWQTY = @OLDQTY + @QTY 
	UPDATE INVENTORY SET STKCOSTRATE=@NEWRATE,STKSELLRATE=@NEWRATE,STKQUANTITY=@NEWQTY WHERE STKID=@ID 
	--UPDATE INVENTORY SET  STKQUANTITY=STKQUANTITY + @NEWQTY WHERE STKID=@ID 
    FETCH NEXT FROM CHANGEINV INTO @STORE,@STOCKNO,@QTY,@RATE
END

CLOSE CHANGEINV
DEALLOCATE CHANGEINV 