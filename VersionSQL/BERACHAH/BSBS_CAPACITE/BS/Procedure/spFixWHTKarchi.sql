/****** Object:  Procedure [BS].[spFixWHTKarchi]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE [BS].[spFixWHTKarchi]
AS

CREATE TABLE #TEMP0(TRANGRP INT) 

INSERT INTO #TEMP0 
SELECT DISTINCT TRANGRP FROM TRANSACTIONS WHERE CONVERT(DATE,SYSDATE)=CONVERT(DATE,GETDATE()) AND LEFT(BATCHREF,3) IN ('CBC','PCP')  AND LEDGERCODE='1320000'  AND HEADID<>1
INTERSECT
SELECT DISTINCT TRANGRP FROM TRANSACTIONS WHERE CONVERT(DATE,SYSDATE)=CONVERT(DATE,GETDATE()) AND LEFT(BATCHREF,3) IN ('CBC','PCP')  AND LEDGERCODE='1310005'  AND HEADID<>1 

DECLARE @LINECOUNT INT
DECLARE @TRANGRP INT
DECLARE @BANKSTART VARCHAR(15) 
DECLARE @BANKEND  VARCHAR(15) 
DECLARE @PARTYTRANSID INT
DECLARE @TDSTRANSID INT
DECLARE @BANKTRANSID INT 
DECLARE @TDSAMOUNT DECIMAL(18,2) 

SELECT  @BANKSTART= CONTROLFROMGL,@BANKEND = CONTROLTOGL FROM CONTROLCODES WHERE CONTROLNAME='Bank' 


DECLARE TRANGRPS CURSOR FOR 
SELECT TRANGRP FROM #TEMP0 
OPEN TRANGRPS 
FETCH NEXT FROM TRANGRPS INTO @TRANGRP 
WHILE @@FETCH_STATUS = 0 
BEGIN
  SELECT @LINECOUNT = COUNT(*) FROM TRANSACTIONS WHERE TRANGRP = @TRANGRP 
  SELECT @TDSAMOUNT = (DEBIT-CREDIT) FROM  TRANSACTIONS WHERE TRANGRP = @TRANGRP AND LEDGERCODE='1310005'
  IF ( @LINECOUNT = 3  ) AND (@TDSAMOUNT > 0 ) 
     BEGIN 
	    SELECT @PARTYTRANSID = TRANSID FROM TRANSACTIONS WHERE TRANGRP = @TRANGRP AND LEDGERCODE='1320000'
		SELECT @TDSTRANSID = TRANSID FROM TRANSACTIONS WHERE TRANGRP = @TRANGRP AND LEDGERCODE='1310005'
		SELECT @BANKTRANSID = TRANSID FROM TRANSACTIONS WHERE TRANGRP = @TRANGRP AND LEDGERCODE BETWEEN @BANKSTART AND @BANKEND 
		SELECT @TDSAMOUNT = DEBIT FROM TRANSACTIONS WHERE TRANGRP = @TRANGRP AND LEDGERCODE='1310005'
		BEGIN TRAN
		 UPDATE TRANSACTIONS SET DEBIT=DEBIT-@TDSAMOUNT WHERE TRANSID = @PARTYTRANSID 
		 UPDATE TRANSACTIONS SET DEBIT=0,CREDIT = @TDSAMOUNT WHERE TRANSID = @TDSTRANSID
		 UPDATE TRANSACTIONS SET CREDIT = CREDIT -@TDSAMOUNT WHERE TRANSID = @BANKTRANSID
		 UPDATE TRANSACTIONS SET HEADID=1 WHERE TRANGRP = @TRANGRP 
		COMMIT TRAN 
		 

	 END
  FETCH NEXT FROM TRANGRPS INTO @TRANGRP 
END
CLOSE TRANGRPS
DEALLOCATE TRANGRPS 

  