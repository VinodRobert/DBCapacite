/****** Object:  Procedure [BS].[spCSTReport]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE   PROCEDURE [BS].[spCSTReport](@BORGID INT,@STARTDATESTRING AS VARCHAR(15),@ENDDATESTRING AS VARCHAR(15),@FINYEAR INT)
AS

DECLARE @VATCODES VARCHAR(25)
DECLARE @STARTINDEX INT
DECLARE @TAXCODE  VARCHAR(2) 

DECLARE @TRANSSTARTDATE    DATETIME
DECLARE @TRANSENDDATE      DATETIME
SELECT  @TRANSSTARTDATE = CONVERT(DATETIME, @STARTDATESTRING,103) -- dd/mm/yyyy 
SELECT  @TRANSENDDATE   = CONVERT(DATETIME, @ENDDATESTRING,103) -- dd/mm/yyyy 

DECLARE @FILENAME VARCHAR(100)
DECLARE @FILEID   VARCHAR(10)
DECLARE @SQL      VARCHAR(250)

DECLARE @CSTLEDGER VARCHAR(10)
SELECT @CSTLEDGER = LEDGERCODE FROM VATGROUPS WHERE VATGC='CS'	

SET @FILENAME = 'BSBS_TEMP.DBO.CST'

SELECT 
 D.TBORGID   ORGID,
 B.BORGNAME  ORGNAME,
 O.SUPPID,
 C.CREDNUMBER SUPPLIERCODE,
 S.SUPPNAME  SUPPLIERNAME,
 P.PROVINCENAME  STATE,
 C.CREDVAT   TIN,
 D.ORDID ,
 O.CREATEDATE  ORDERDATE,
 O.ORDNUMBER  ORDERNUMBER,
 OI.LINENUMBER   LINENUMBER,
 OI.ITEMDESCRIPTION  MATERIALNAME,
 OI.QTY      ORDEREDQTY,
 OI.UOM      UNIT,
 OI.PRICE    PURCHASEPRICE,
 OI.VATPERC  TAXPERCENT,
 OI.VATID,
 OI.VATAMOUNT VATAMOUNT,
 D.DLVRNO,
 D.GRNNO     GRN,
 D.DLVRQTY   DELIVERYQTY,
 D.DLVRDATE  DELIVERYDATE,
 D.RECONQTY  RECONQTY,
 D.PRICE     DELIVERYPRICE ,
 @TRANSSTARTDATE STARTDATE ,
 @TRANSENDDATE ENDDATE
INTO #TEMP0 
FROM 
 DELIVERIES  D
 INNER JOIN ORDITEMS OI ON D.ORDITEMLINENO = OI.LINENUMBER AND D.ORDID=OI.ORDID 
 INNER JOIN ORD O ON OI.ORDID = O.ORDID 
 INNER JOIN SUPPLIERS S ON O.SUPPID = S.SUPPID 
 INNER JOIN BORGS B ON B.BORGID = D.TBORGID
 INNER JOIN CREDITORS C ON S.SUPPCODE= C.CREDNUMBER 
 INNER JOIN PROVINCES P ON C.PROVINCEID = P.PROVINCEID 
WHERE 
  OI.VATID LIKE '%CS%' AND ALLOCATED=1  AND D.LYEAR=@FINYEAR AND D.TBORGID = @BORGID AND
  D.DLVRDATE BETWEEN @TRANSSTARTDATE AND @TRANSENDDATE 

ALTER TABLE #TEMP0 ADD TRANGRP INT
UPDATE #TEMP0 SET TRANGRP = ISNULL(T.TRANGRP,0)
FROM TRANSACTIONS T
INNER JOIN #TEMP0 ON #TEMP0.GRN = T.REQNO AND #TEMP0.ORDERNUMBER = T.ORDERNO 

ALTER TABLE #TEMP0 ADD INVOICEDATE DATETIME
ALTER TABLE #TEMP0 ADD INVOICEAMOUNT DECIMAL(18,2)
ALTER TABLE #TEMP0 ADD INVOICENUMBER VARCHAR(10)

UPDATE #TEMP0 SET INVOICEDATE = T.RECEIVEDDATE, INVOICEAMOUNT=T.CREDIT ,INVOICENUMBER=T.TRANSREF 
FROM TRANSACTIONS T INNER JOIN #TEMP0 ON #TEMP0.TRANGRP = T.TRANGRP AND T.LEDGERCODE='1315000'

ALTER TABLE #TEMP0 ADD  VATCODE CHAR(2)
ALTER TABLE #TEMP0 ADD  CSTPERCENT DECIMAL(18,2)

DECLARE VATCODES CURSOR FOR SELECT DISTINCT LTRIM(RTRIM(VATID)) FROM #TEMP0 
OPEN VATCODES 

FETCH NEXT FROM VATCODES INTO @VATCODES

WHILE @@FETCH_STATUS = 0
BEGIN
   SELECT  @STARTINDEX= PATINDEX('%:CS%',LTRIM(RTRIM(@VATCODES)))  
   SELECT  @TAXCODE = SUBSTRING(@VATCODES,@STARTINDEX-2,2)
   UPDATE #TEMP0 SET VATCODE  = @TAXCODE WHERE LTRIM(RTRIM(VATID))=@VATCODES 
   FETCH NEXT FROM VATCODES INTO @VATCODES  
END	
CLOSE VATCODES
DEALLOCATE VATCODES 	
UPDATE #TEMP0 SET CSTPERCENT  = VT.VATPERC FROM VATTYPES VT INNER JOIN #TEMP0 ON #TEMP0.VATCODE = VT.VATID AND #TEMP0.ORGID = VT.BORGID 
UPDATE #TEMP0 SET CSTPERCENT = 0 WHERE CSTPERCENT IS NULL


INSERT INTO #TEMP0(ORGID, ORGNAME , MATERIALNAME, VATAMOUNT ,STARTDATE , ENDDATE,SUPPID,SUPPLIERCODE,
SUPPLIERNAME,STATE,TIN,ORDID,ORDERDATE,ORDERNUMBER,LINENUMBER,ORDEREDQTY,UNIT,PURCHASEPRICE,TAXPERCENT,VATID,DLVRNO,GRN,DELIVERYQTY,DELIVERYDATE,RECONQTY,INVOICEAMOUNT) 
SELECT T.ORGID,B.BORGNAME,T.DESCRIPTION,(T.DEBIT-T.CREDIT),@TRANSSTARTDATE,@TRANSENDDATE,0,'ZZZZZZZZZZ','Z JOURNAL ENTRIES',
SPACE(10),SPACE(10),SPACE(10),T.PDATE,T.TRANSREF,0 ,0,SPACE(5),0,0,99,T.BATCHREF,T.TRANSREF,0 ,PDATE ,0 ,(T.DEBIT-T.CREDIT) FROM 
TRANSACTIONS T INNER JOIN BORGS B ON T.ORGID=B.BORGID AND T.ORGID = @BORGID AND T.PDATE BETWEEN @TRANSSTARTDATE AND @TRANSENDDATE AND T.LEDGERCODE=@CSTLEDGER 
 
SELECT * FROM #TEMP0

DECLARE @Random INT;
DECLARE @Upper INT;
DECLARE @Lower INT
 
SET @Lower = 1 ---- The lowest random number
SET @Upper = 999 ---- The highest random number
SELECT @Random = ROUND(((@Upper - @Lower -1) * RAND() + @Lower), 0)

SELECT @FILEID= CONVERT(INT,RAND( (DATEPART(mm, GETDATE()) * 100000 )
	+ (DATEPART(ss, GETDATE()) * 1000 )
	+ DATEPART(ms, GETDATE()) )*1000) + STR(@RANDOM) 

SET @FILENAME = @FILENAME+LTRIM(RTRIM(CONVERT(VARCHAR(6),@FILEID)))
select @filename
SET @SQL = 'SELECT *  INTO '+@FILENAME+ ' FROM   #TEMP0  ORDER BY SUPPID '
 
EXEC(@SQL)

RETURN @FILEID