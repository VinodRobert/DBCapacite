/****** Object:  Procedure [BS].[spSiteEstablishmentMatching]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE PROCEDURE  BS.spSiteEstablishmentMatching
as

DECLARE @STKSTORE VARCHAR(10)
DECLARE @STKCODE  VARCHAR(15)
DECLARE @STKDESC  VARCHAR(250)
DECLARE @STKUNIT  VARCHAR(15)
DECLARE @STKQTY   DECIMAL(18,4)
DECLARE @STKRATE  MONEY
DECLARE @TRANSID  INT

DECLARE @FOUND INT
DECLARE INVENTORY CURSOR FOR
SELECT STKSTORE,STKCODE,STKDESC,STKUNIT,STKQUANTITY,STKCOSTRATE 
FROM INVENTORY WHERE LEFT(STKSTORE,2)='SE'

OPEN INVENTORY
FETCH NEXT FROM INVENTORY INTO @STKSTORE,@STKCODE,@STKDESC,@STKUNIT,@STKQTY,@STKRATE 

WHILE @@FETCH_STATUS=0
BEGIN
  IF @STKQTY > 0 
   BEGIN
       SET @FOUND = 0 
       SELECT @FOUND = TRANSID  FROM TRANSACTIONS WHERE STORE = @STKSTORE  AND STOCKNO=@STKCODE  AND QUANTITY = @STKQTY AND RATE = @STKRATE 
       IF @FOUND = 0 
           SELECT @STKSTORE,@STKCODE,@STKDESC,@STKUNIT,@STKQTY,@STKRATE
       SET @FOUND = 0 
   END
   FETCH NEXT FROM INVENTORY INTO @STKSTORE,@STKCODE,@STKDESC,@STKUNIT,@STKQTY,@STKRATE 

END
CLOSE INVENTORY
DEALLOCATE INVENTORY