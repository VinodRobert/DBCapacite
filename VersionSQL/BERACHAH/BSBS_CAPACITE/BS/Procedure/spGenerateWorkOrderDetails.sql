/****** Object:  Procedure [BS].[spGenerateWorkOrderDetails]    Committed by VersionSQL https://www.versionsql.com ******/

 

CREATE PROCEDURE [BS].[spGenerateWorkOrderDetails](@BORGID INT,@STARTDATESTRING VARCHAR(15), @ENDDATESTRING VARCHAR(15) ) 
AS

DECLARE @BORGNAME   VARCHAR(100)
DECLARE @TRANSSTARTDATE    DATETIME
DECLARE @TRANSENDDATE      DATETIME
SELECT  @TRANSSTARTDATE = CONVERT(DATETIME, @STARTDATESTRING,103) -- dd/mm/yyyy 
SELECT  @TRANSENDDATE   = CONVERT(DATETIME, @ENDDATESTRING,103) -- dd/mm/yyyy 

DECLARE @FILENAME VARCHAR(100)
DECLARE @FILEID   VARCHAR(10)
DECLARE @SQL      VARCHAR(250)
SET @FILENAME = 'BSBS_TEMP.DBO.WORKORDERS'

SELECT H.[HeaderId]
      ,H.[ReconID]
      ,D.[Use]
      ,D.[doc ref]
	  ,D.DETAILID 
      ,D.[description]
      ,D.[unit]
      ,D.[quantity]
      ,D.[prog QTY]
      ,D.[prev QTY]
      ,D.[final QTY]
      ,D.[rate]
      ,D.[amount]
      ,D.[ACTID] 
	  ,S.ORGID
	  ,S.SUBCONNUMBER 
	  ,SUB.SUBNUMBER 
	  ,S.CONTRACT 
	  ,S.ACTIVITY 
	  ,S.VALNO 
	  ,S.CERTNO 
	  ,S.CONTVALUE 
	  ,S.SUPNAME 
	  ,S.REMARK 
	  ,S.ORDERNO 
	  ,O.CREATEDATE
	  ,S.LEDGER
	  ,S.POSTDATE
	  ,A.ACTNAME
	  ,L.LEDGERNAME 
	  ,C.CONTRNAME
  INTO #TEMP0 
  FROM [dbo].[ACCBOQHeader] H INNER JOIN  [dbo].[ACCBOQDetail] D  ON H.HEADERID = D.HEADERID 
       INNER JOIN SUBCRECONS  S  ON H.RECONID = S.RECONID 
	   INNER JOIN ACTIVITIES  A  ON D.ACTID = A.ACTID 
	   INNER JOIN LEDGERCODES L  ON S.LEDGER = L.LEDGERCODE 
	   INNER JOIN CONTRACTS   C  ON S.CONTRACT = C.CONTRID 
	   INNER JOIN ORD         O  ON S.ORDERNO = O.ORDNUMBER 
	   INNER JOIN SUBCONTRACTORS SUB ON S.SUBCONNUMBER=SUB.SUBID 
  WHERE
       DESCRIPTION NOT LIKE 'Scheduled Items%' AND 
	   S.ORGID=@BORGID AND
	   S.POSTDATE BETWEEN @TRANSSTARTDATE AND @TRANSENDDATE AND
	   D.ReconHistID = -1
  ORDER BY ORDERNO DESC,RECONID,DETAILID 
  
  ALTER TABLE #TEMP0 ADD BORGNAME VARCHAR(100)
  ALTER TABLE #TEMP0 ADD STARTDATE DATETIME
  ALTER TABLE #TEMP0 ADD ENDDATE   DATETIME

  SELECT @BORGNAME=BORGNAME FROM BORGS WHERE BORGID=@BORGID
  UPDATE #TEMP0 SET BORGNAME=@BORGNAME , STARTDATE=@TRANSSTARTDATE, ENDDATE=@TRANSENDDATE 

  UPDATE #TEMP0 SET SUPNAME=UPPER(SUPNAME)
  UPDATE #TEMP0 SET ORDERNO=UPPER(ORDERNO)
  UPDATE #TEMP0 SET ACTNAME=UPPER(ACTNAME)
  UPDATE #TEMP0 SET LEDGERNAME= UPPER(LEDGERNAME) 
  UPDATE #TEMP0 SET CONTRNAME = UPPER(CONTRNAME)
  UPDATE #TEMP0 SET REMARK = UPPER(REMARK)
  --UPDATE #TEMP0 SET DESCRIPTION = UPPER(DESCRIPTION) 

 
DECLARE @Random INT;
DECLARE @Upper INT;
DECLARE @Lower INT
 
SET @Lower = 1 ---- The lowest random number
SET @Upper = 999 ---- The highest random number
SELECT @Random = ROUND(((@Upper - @Lower -1) * RAND() + @Lower), 0)

SELECT @FILEID= CONVERT(INT,RAND( (DATEPART(mm, GETDATE()) * 100000 )
+ (DATEPART(ss, GETDATE()) * 1000 )
+ DATEPART(ms, GETDATE()) )*1000) + STR(@RANDOM) 

SET @FILENAME = @FILENAME+LTRIM(RTRIM(CONVERT(VARCHAR(6),@FILEID)))
SET @SQL = 'SELECT *  INTO '+@FILENAME+ ' FROM   #TEMP0 ORDER BY ORDERNO DESC,RECONID,DETAILID   '
EXEC(@SQL)
SELECT @FILENAME 
RETURN @FILEID
 