/****** Object:  Function [dbo].[f_GetStartDate]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE FUNCTION f_GetStartDate  ( 	@PERIODNO AS INT, 	@YEARNO AS INT, 	@PAYROLLID AS INT ) RETURNS DATETIME AS begin 	DECLARE @STARTDATE AS DATETIME 	DECLARE @TAXYEARSTARTDATE AS DATETIME 	SET @TAXYEARSTARTDATE = CONVERT(DATETIME, (select TOP 1 CONVERT (NVARCHAR, STARTDATE, 103)                                FROM   PAYROLLTAXYEARS                                WHERE  PAYROLLID = @PAYROLLID AND TAXYEAR = @YEARNO), 103)  	IF (select COUNT(*) FROM PAYROLLTAXYEARS WHERE PAYROLLID = @PayrollID AND TAXYEAR = @YearNo) = 0     BEGIN          SELECT @YearNo = MIN(TAXYEAR) FROM PAYROLLTAXYEARS WHERE PAYROLLID = @PayrollID     END     SELECT @STARTDATE = CONVERT(DATETIME, CASE      		WHEN @PERIODNO < 2 THEN CONVERT (NVARCHAR, @TAXYEARSTARTDATE, 103)      		ELSE (select TOP 1 ISNULL(CONVERT (NVARCHAR, MAX(PE0.PENDDATE + 1), 103), CONVERT (NVARCHAR,@TAXYEARSTARTDATE,103))     			  FROM   PERIODENDDATES AS PE1     					 INNER JOIN     					 PAYROLLS AS P     					 ON P.PAYROLLID = PE1.PAYROLLID     					 LEFT OUTER JOIN     					 PERIODENDDATES AS PE0     					 ON PE0.YEARNO = PE1.YEARNO     						AND PE0.PAYROLLID = PE1.PAYROLLID     			  WHERE  PE1.PAYROLLID = @PAYROLLID     					 AND PE1.PERIODNO <= @PERIODNO     					 AND PE1.YEARNO = @YEARNO      					 AND PE0.PENDDATE < PE1.PENDDATE)      END,103) 	RETURN @STARTDATE end 