/****** Object:  View [dbo].[TRIALBALANCE]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE VIEW TRIALBALANCE
AS
select 
T.ORGID [OrgID], T.YEAR [Year], T.ALLOCATION [Allocation], T.LEDGERCODE [Ledger Code], LEDGERCODES.LEDGERNAME [Ledger Name],
isnull(LEDGERCODES.CONTROLTYPE, '') [Control Type], isnull(CONTROLCODES.CONTROLNAME, '') [Control Name],
SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD = 0 then A.AMOUNT ELSE 0 END) as [Period 0 - OB], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 1 then A.AMOUNT ELSE 0 END) as [Period 1],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 1 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 1], BUDGET.[Period 1 Budget], budget.[YTD Period 1 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 2 then A.AMOUNT ELSE 0 END) as [Period 2],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 2 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 2], BUDGET.[Period 2 Budget], budget.[YTD Period 2 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 3 then A.AMOUNT ELSE 0 END) as [Period 3],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 3 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 3], BUDGET.[Period 3 Budget], budget.[YTD Period 3 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 4 then A.AMOUNT ELSE 0 END) as [Period 4],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 4 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 4], BUDGET.[Period 4 Budget], budget.[YTD Period 4 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 5 then A.AMOUNT ELSE 0 END) as [Period 5],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 5 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 5], BUDGET.[Period 5 Budget], budget.[YTD Period 5 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 6 then A.AMOUNT ELSE 0 END) as [Period 6],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 6 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 6], BUDGET.[Period 6 Budget], budget.[YTD Period 6 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 7 then A.AMOUNT ELSE 0 END) as [Period 7],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 7 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 7], BUDGET.[Period 7 Budget], budget.[YTD Period 7 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 8 then A.AMOUNT ELSE 0 END) as [Period 8],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 8 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 8], BUDGET.[Period 8 Budget], budget.[YTD Period 8 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 9 then A.AMOUNT ELSE 0 END) as [Period 9],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 9 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 9], BUDGET.[Period 9 Budget], budget.[YTD Period 9 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 10 then A.AMOUNT ELSE 0 END) as [Period 10],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 10 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 10], BUDGET.[Period 10 Budget], budget.[YTD Period 10 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 11 then A.AMOUNT ELSE 0 END) as [Period 11],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 11 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 11], BUDGET.[Period 11 Budget], budget.[YTD Period 11 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 12 then A.AMOUNT ELSE 0 END) as [Period 12],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 12 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 12], BUDGET.[Period 12 Budget], budget.[YTD Period 12 Budget], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 13 then A.AMOUNT ELSE 0 END) as [Period 13],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 13 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 13], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 14 then A.AMOUNT ELSE 0 END) as [Period 14],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 14 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 14], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 15 then A.AMOUNT ELSE 0 END) as [Period 15],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 15 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 15], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 16 then A.AMOUNT ELSE 0 END) as [Period 16],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 16 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 16], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 17 then A.AMOUNT ELSE 0 END) as [Period 17],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 17 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 17], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 18 then A.AMOUNT ELSE 0 END) as [Period 18],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 18 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 18], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 19 then A.AMOUNT ELSE 0 END) as [Period 19],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 19 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 19], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 20 then A.AMOUNT ELSE 0 END) as [Period 20],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 20 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 20], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 21 then A.AMOUNT ELSE 0 END) as [Period 21],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 21 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 21], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 22 then A.AMOUNT ELSE 0 END) as [Period 22],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 22 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 22], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 23 then A.AMOUNT ELSE 0 END) as [Period 23],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 23 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 23], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 24 then A.AMOUNT ELSE 0 END) as [Period 24],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 24 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 24], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 25 then A.AMOUNT ELSE 0 END) as [Period 25],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 25 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 25], 
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 and T.PERIOD  = 26 then A.AMOUNT ELSE 0 END) as [Period 26],
		SUM(CASE WHEN isnull(P.ISYEAREND, 1) = 0 AND T.PERIOD <= 26 THEN A.AMOUNT ELSE 0 END) AS [YTD Period 26], 
Budget.[Year Budget], 
SUM(CASE WHEN P.ISYEAREND = 1 then A.AMOUNT ELSE 0 END) as [Period YE],
SUM(CASE WHEN isnull(P.ISYEAREND, -1) = -1 then A.AMOUNT ELSE 0 END) as [Period undefined],
SUM(A.AMOUNT) as [Total] 
, A10.VALUE [LEDGERCODES Attribute.Sales % Effect in Budget], A11.VALUE [LEDGERCODES Attribute.View Type], A12.VALUE [LEDGERCODES Attribute.WHT Applicable], A9.VALUE [LEDGERCODES Attribute.Cash Flow Markers]
FROM TRANSACTIONS T
INNER JOIN BORGS B on T.ORGID = B.BORGID
INNER JOIN LEDGERCODES ON T.LEDGERCODE = LEDGERCODES.LEDGERCODE 
OUTER APPLY (SELECT TOP 1 CONTROLCODES.CONTROLNAME FROM CONTROLCODES WHERE LEDGERCODES.LEDGERCODE BETWEEN CONTROLCODES.CONTROLFROMGL AND CONTROLCODES.CONTROLTOGL ORDER BY CONTROLCODES.CONTROLFROMGL) CONTROLCODES
LEFT OUTER JOIN CONTROLCODES CR ON T.LEDGERCODE = CR.CONTROLFROMGL and CR.CONTROLNAME = 'Retained Income'
LEFT OUTER JOIN CONTROLCODES CW ON T.LEDGERCODE = CW.CONTROLFROMGL and CW.CONTROLNAME = 'Work In Progress'
LEFT OUTER JOIN PERIODSETUP P on P.ORGID = T.OrgID and P.YEAR = T.YEAR and P.PERIOD = T.PERIOD
OUTER APPLY (select CASE WHEN T.CURRENCY = B.CURRENCY THEN DEBIT - CREDIT ELSE CASE WHEN DEBIT - CREDIT > 0 THEN HOMECURRAMOUNT ELSE -1 * HOMECURRAMOUNT END END as AMOUNT) A 
 LEFT OUTER JOIN ATTRIBVALUE A10 on A10.TABLENAME = 'LEDGERCODES' and A10.ATTRIBUTE = 'Sales % Effect in Budget' and A10.COLKEY = LEDGERCODES.LEDGERCODE and A10.ARRAYINDEX = 0 LEFT OUTER JOIN ATTRIBVALUE A11 on A11.TABLENAME = 'LEDGERCODES' and A11.ATTRIBUTE = 'View Type' and A11.COLKEY = LEDGERCODES.LEDGERCODE and A11.ARRAYINDEX = 0 LEFT OUTER JOIN ATTRIBVALUE A12 on A12.TABLENAME = 'LEDGERCODES' and A12.ATTRIBUTE = 'WHT Applicable' and A12.COLKEY = LEDGERCODES.LEDGERCODE and A12.ARRAYINDEX = 0 LEFT OUTER JOIN ATTRIBVALUE A9 on A9.TABLENAME = 'LEDGERCODES' and A9.ATTRIBUTE = 'Cash Flow Markers' and A9.COLKEY = LEDGERCODES.LEDGERCODE and A9.ARRAYINDEX = 0 LEFT OUTER JOIN (  SELECT OHBUDGETS.BORGID, OHBUDGETS.YEARNO as YEAR, LC.LEDGERCODE, 'Overheads' ALLOCATION,  sum(case when OHBUDGETS.PERIOD = 1 then case when isnull(FC1.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC1.FCAMOUNT, 0) end else 0 end) [Period 1 Budget],  sum(case when OHBUDGETS.PERIOD <= 1 then case when isnull(FC1.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC1.FCAMOUNT, 0) end else 0 end) [YTD Period 1 Budget],  sum(case when OHBUDGETS.PERIOD = 2 then case when isnull(FC2.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC2.FCAMOUNT, 0) end else 0 end) [Period 2 Budget],  sum(case when OHBUDGETS.PERIOD <= 2 then case when isnull(FC2.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC2.FCAMOUNT, 0) end else 0 end) [YTD Period 2 Budget],  sum(case when OHBUDGETS.PERIOD = 3 then case when isnull(FC3.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC3.FCAMOUNT, 0) end else 0 end) [Period 3 Budget],  sum(case when OHBUDGETS.PERIOD <= 3 then case when isnull(FC3.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC3.FCAMOUNT, 0) end else 0 end) [YTD Period 3 Budget],  sum(case when OHBUDGETS.PERIOD = 4 then case when isnull(FC4.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC4.FCAMOUNT, 0) end else 0 end) [Period 4 Budget],  sum(case when OHBUDGETS.PERIOD <= 4 then case when isnull(FC4.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC4.FCAMOUNT, 0) end else 0 end) [YTD Period 4 Budget],  sum(case when OHBUDGETS.PERIOD = 5 then case when isnull(FC5.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC5.FCAMOUNT, 0) end else 0 end) [Period 5 Budget],  sum(case when OHBUDGETS.PERIOD <= 5 then case when isnull(FC5.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC5.FCAMOUNT, 0) end else 0 end) [YTD Period 5 Budget],  sum(case when OHBUDGETS.PERIOD = 6 then case when isnull(FC6.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC6.FCAMOUNT, 0) end else 0 end) [Period 6 Budget],  sum(case when OHBUDGETS.PERIOD <= 6 then case when isnull(FC6.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC6.FCAMOUNT, 0) end else 0 end) [YTD Period 6 Budget],  sum(case when OHBUDGETS.PERIOD = 7 then case when isnull(FC7.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC7.FCAMOUNT, 0) end else 0 end) [Period 7 Budget],  sum(case when OHBUDGETS.PERIOD <= 7 then case when isnull(FC7.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC7.FCAMOUNT, 0) end else 0 end) [YTD Period 7 Budget],  sum(case when OHBUDGETS.PERIOD = 8 then case when isnull(FC8.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC8.FCAMOUNT, 0) end else 0 end) [Period 8 Budget],  sum(case when OHBUDGETS.PERIOD <= 8 then case when isnull(FC8.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC8.FCAMOUNT, 0) end else 0 end) [YTD Period 8 Budget],  sum(case when OHBUDGETS.PERIOD = 9 then case when isnull(FC9.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC9.FCAMOUNT, 0) end else 0 end) [Period 9 Budget],  sum(case when OHBUDGETS.PERIOD <= 9 then case when isnull(FC9.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC9.FCAMOUNT, 0) end else 0 end) [YTD Period 9 Budget],  sum(case when OHBUDGETS.PERIOD = 10 then case when isnull(FC10.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC10.FCAMOUNT, 0) end else 0 end) [Period 10 Budget],  sum(case when OHBUDGETS.PERIOD <= 10 then case when isnull(FC10.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC10.FCAMOUNT, 0) end else 0 end) [YTD Period 10 Budget],  sum(case when OHBUDGETS.PERIOD = 11 then case when isnull(FC11.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC11.FCAMOUNT, 0) end else 0 end) [Period 11 Budget],  sum(case when OHBUDGETS.PERIOD <= 11 then case when isnull(FC11.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC11.FCAMOUNT, 0) end else 0 end) [YTD Period 11 Budget],  sum(case when OHBUDGETS.PERIOD = 12 then case when isnull(FC12.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC12.FCAMOUNT, 0) end else 0 end) [Period 12 Budget],  sum(case when OHBUDGETS.PERIOD <= 12 then case when isnull(FC12.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC12.FCAMOUNT, 0) end else 0 end) [YTD Period 12 Budget],  sum(case when isnull(FC12.FCAMOUNT, 0) = 0 then OHBUDGETS.BUDGET else isnull(FC12.FCAMOUNT, 0) end) [Year Budget]  FROM OHBUDGETS INNER JOIN LEDGERCODES LC on LC.LedgerID = OHBUDGETS.LEDGERID  outer apply (select top 1 FC.FORECAST1 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 1 AND FC.FORECAST1 <> 0 ORDER BY PERIOD DESC) FC1  outer apply (select top 1 FC.FORECAST2 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 2 AND FC.FORECAST2 <> 0 ORDER BY PERIOD DESC) FC2  outer apply (select top 1 FC.FORECAST3 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 3 AND FC.FORECAST3 <> 0 ORDER BY PERIOD DESC) FC3  outer apply (select top 1 FC.FORECAST4 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 4 AND FC.FORECAST4 <> 0 ORDER BY PERIOD DESC) FC4  outer apply (select top 1 FC.FORECAST5 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 5 AND FC.FORECAST5 <> 0 ORDER BY PERIOD DESC) FC5  outer apply (select top 1 FC.FORECAST6 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 6 AND FC.FORECAST6 <> 0 ORDER BY PERIOD DESC) FC6  outer apply (select top 1 FC.FORECAST7 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 7 AND FC.FORECAST7 <> 0 ORDER BY PERIOD DESC) FC7  outer apply (select top 1 FC.FORECAST8 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 8 AND FC.FORECAST8 <> 0 ORDER BY PERIOD DESC) FC8  outer apply (select top 1 FC.FORECAST9 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 9 AND FC.FORECAST9 <> 0 ORDER BY PERIOD DESC) FC9  outer apply (select top 1 FC.FORECAST10 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 10 AND FC.FORECAST10 <> 0 ORDER BY PERIOD DESC) FC10  outer apply (select top 1 FC.FORECAST11 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 11 AND FC.FORECAST11 <> 0 ORDER BY PERIOD DESC) FC11  outer apply (select top 1 FC.FORECAST12 FCAMOUNT from OHFORECAST FC WHERE FC.BORGID = OHBUDGETS.BORGID and FC.LEDGERID = OHBUDGETS.LEDGERID and fc.YEARNO = OHBUDGETS.YEARNO and FC.DIVID = OHBUDGETS.DIVID and FC.PERIOD <= 12 AND FC.FORECAST12 <> 0 ORDER BY PERIOD DESC) FC12  group by OHBUDGETS.BORGID, OHBUDGETS.YEARNO, LC.LEDGERCODE  UNION ALL  SELECT PDBUDGETS.BORGID, PDBUDGETS.YEARNO as YEAR, LC.LEDGERCODE, 'Plant' ALLOCATION,  sum(case when PDBUDGETS.PERIOD = 1 then case when isnull(FC1.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC1.FCAMOUNT, 0) end else 0 end) [Period 1 Budget],  sum(case when PDBUDGETS.PERIOD <= 1 then case when isnull(FC1.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC1.FCAMOUNT, 0) end else 0 end) [YTD Period 1 Budget],  sum(case when PDBUDGETS.PERIOD = 2 then case when isnull(FC2.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC2.FCAMOUNT, 0) end else 0 end) [Period 2 Budget],  sum(case when PDBUDGETS.PERIOD <= 2 then case when isnull(FC2.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC2.FCAMOUNT, 0) end else 0 end) [YTD Period 2 Budget],  sum(case when PDBUDGETS.PERIOD = 3 then case when isnull(FC3.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC3.FCAMOUNT, 0) end else 0 end) [Period 3 Budget],  sum(case when PDBUDGETS.PERIOD <= 3 then case when isnull(FC3.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC3.FCAMOUNT, 0) end else 0 end) [YTD Period 3 Budget],  sum(case when PDBUDGETS.PERIOD = 4 then case when isnull(FC4.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC4.FCAMOUNT, 0) end else 0 end) [Period 4 Budget],  sum(case when PDBUDGETS.PERIOD <= 4 then case when isnull(FC4.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC4.FCAMOUNT, 0) end else 0 end) [YTD Period 4 Budget],  sum(case when PDBUDGETS.PERIOD = 5 then case when isnull(FC5.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC5.FCAMOUNT, 0) end else 0 end) [Period 5 Budget],  sum(case when PDBUDGETS.PERIOD <= 5 then case when isnull(FC5.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC5.FCAMOUNT, 0) end else 0 end) [YTD Period 5 Budget],  sum(case when PDBUDGETS.PERIOD = 6 then case when isnull(FC6.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC6.FCAMOUNT, 0) end else 0 end) [Period 6 Budget],  sum(case when PDBUDGETS.PERIOD <= 6 then case when isnull(FC6.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC6.FCAMOUNT, 0) end else 0 end) [YTD Period 6 Budget],  sum(case when PDBUDGETS.PERIOD = 7 then case when isnull(FC7.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC7.FCAMOUNT, 0) end else 0 end) [Period 7 Budget],  sum(case when PDBUDGETS.PERIOD <= 7 then case when isnull(FC7.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC7.FCAMOUNT, 0) end else 0 end) [YTD Period 7 Budget],  sum(case when PDBUDGETS.PERIOD = 8 then case when isnull(FC8.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC8.FCAMOUNT, 0) end else 0 end) [Period 8 Budget],  sum(case when PDBUDGETS.PERIOD <= 8 then case when isnull(FC8.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC8.FCAMOUNT, 0) end else 0 end) [YTD Period 8 Budget],  sum(case when PDBUDGETS.PERIOD = 9 then case when isnull(FC9.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC9.FCAMOUNT, 0) end else 0 end) [Period 9 Budget],  sum(case when PDBUDGETS.PERIOD <= 9 then case when isnull(FC9.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC9.FCAMOUNT, 0) end else 0 end) [YTD Period 9 Budget],  sum(case when PDBUDGETS.PERIOD = 10 then case when isnull(FC10.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC10.FCAMOUNT, 0) end else 0 end) [Period 10 Budget],  sum(case when PDBUDGETS.PERIOD <= 10 then case when isnull(FC10.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC10.FCAMOUNT, 0) end else 0 end) [YTD Period 10 Budget],  sum(case when PDBUDGETS.PERIOD = 11 then case when isnull(FC11.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC11.FCAMOUNT, 0) end else 0 end) [Period 11 Budget],  sum(case when PDBUDGETS.PERIOD <= 11 then case when isnull(FC11.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC11.FCAMOUNT, 0) end else 0 end) [YTD Period 11 Budget],  sum(case when PDBUDGETS.PERIOD = 12 then case when isnull(FC12.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC12.FCAMOUNT, 0) end else 0 end) [Period 12 Budget],  sum(case when PDBUDGETS.PERIOD <= 12 then case when isnull(FC12.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC12.FCAMOUNT, 0) end else 0 end) [YTD Period 12 Budget],  sum(case when isnull(FC12.FCAMOUNT, 0) = 0 then PDBUDGETS.BUDGET else isnull(FC12.FCAMOUNT, 0) end) [Year Budget]  FROM PDBUDGETS INNER JOIN LEDGERCODES LC on LC.LedgerID = PDBUDGETS.LEDGERID  outer apply (select top 1 FC.FORECAST1 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 1 AND FC.FORECAST1 <> 0 ORDER BY PERIOD DESC) FC1  outer apply (select top 1 FC.FORECAST2 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 2 AND FC.FORECAST2 <> 0 ORDER BY PERIOD DESC) FC2  outer apply (select top 1 FC.FORECAST3 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 3 AND FC.FORECAST3 <> 0 ORDER BY PERIOD DESC) FC3  outer apply (select top 1 FC.FORECAST4 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 4 AND FC.FORECAST4 <> 0 ORDER BY PERIOD DESC) FC4  outer apply (select top 1 FC.FORECAST5 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 5 AND FC.FORECAST5 <> 0 ORDER BY PERIOD DESC) FC5  outer apply (select top 1 FC.FORECAST6 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 6 AND FC.FORECAST6 <> 0 ORDER BY PERIOD DESC) FC6  outer apply (select top 1 FC.FORECAST7 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 7 AND FC.FORECAST7 <> 0 ORDER BY PERIOD DESC) FC7  outer apply (select top 1 FC.FORECAST8 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 8 AND FC.FORECAST8 <> 0 ORDER BY PERIOD DESC) FC8  outer apply (select top 1 FC.FORECAST9 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 9 AND FC.FORECAST9 <> 0 ORDER BY PERIOD DESC) FC9  outer apply (select top 1 FC.FORECAST10 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 10 AND FC.FORECAST10 <> 0 ORDER BY PERIOD DESC) FC10  outer apply (select top 1 FC.FORECAST11 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 11 AND FC.FORECAST11 <> 0 ORDER BY PERIOD DESC) FC11  outer apply (select top 1 FC.FORECAST12 FCAMOUNT from PDFORECAST FC WHERE FC.BORGID = PDBUDGETS.BORGID and FC.LEDGERID = PDBUDGETS.LEDGERID and fc.YEARNO = PDBUDGETS.YEARNO and FC.DIVID = PDBUDGETS.DIVID and FC.PERIOD <= 12 AND FC.FORECAST12 <> 0 ORDER BY PERIOD DESC) FC12  group by PDBUDGETS.BORGID, PDBUDGETS.YEARNO, LC.LEDGERCODE  UNION ALL  SELECT BUDGETS.BORGID, BUDGETS.YEARNO as YEAR, LC.LEDGERCODE, 'Contracts' ALLOCATION,  sum(case when BUDGETS.PERIOD = 1 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 1 Budget],  sum(case when BUDGETS.PERIOD <= 1 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 1 Budget],  sum(case when BUDGETS.PERIOD = 2 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 2 Budget],  sum(case when BUDGETS.PERIOD <= 2 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 2 Budget],  sum(case when BUDGETS.PERIOD = 3 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 3 Budget],  sum(case when BUDGETS.PERIOD <= 3 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 3 Budget],  sum(case when BUDGETS.PERIOD = 4 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 4 Budget],  sum(case when BUDGETS.PERIOD <= 4 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 4 Budget],  sum(case when BUDGETS.PERIOD = 5 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 5 Budget],  sum(case when BUDGETS.PERIOD <= 5 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 5 Budget],  sum(case when BUDGETS.PERIOD = 6 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 6 Budget],  sum(case when BUDGETS.PERIOD <= 6 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 6 Budget],  sum(case when BUDGETS.PERIOD = 7 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 7 Budget],  sum(case when BUDGETS.PERIOD <= 7 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 7 Budget],  sum(case when BUDGETS.PERIOD = 8 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 8 Budget],  sum(case when BUDGETS.PERIOD <= 8 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 8 Budget],  sum(case when BUDGETS.PERIOD = 9 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 9 Budget],  sum(case when BUDGETS.PERIOD <= 9 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 9 Budget],  sum(case when BUDGETS.PERIOD = 10 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 10 Budget],  sum(case when BUDGETS.PERIOD <= 10 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 10 Budget],  sum(case when BUDGETS.PERIOD = 11 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 11 Budget],  sum(case when BUDGETS.PERIOD <= 11 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 11 Budget],  sum(case when BUDGETS.PERIOD = 12 then case when   isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [Period 12 Budget],  sum(case when BUDGETS.PERIOD <= 12 then case when  isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end else 0 end) [YTD Period 12 Budget],  sum(case when isnull(BUDGETS.BUDGETFE, 0) = 0 then BUDGETS.BUDGET else isnull(BUDGETS.BUDGETFE, 0) end) [Year Budget]  FROM BUDGETS INNER JOIN LEDGERCODES LC on LC.LedgerID = BUDGETS.LEDGERID  group by BUDGETS.BORGID, BUDGETS.YEARNO, LC.LEDGERCODE  ) BUDGET ON BUDGET.BORGID = T.ORGID AND BUDGET.YEAR = T.YEAR AND BUDGET.ALLOCATION = T.ALLOCATION AND BUDGET.LEDGERCODE = T.LEDGERCODE 
WHERE isnull(CR.CONTROLNAME, '') = ''
AND isnull(CW.CONTROLNAME, '') = ''
GROUP BY T.ORGID, T.YEAR, T.ALLOCATION, T.LEDGERCODE, LEDGERCODES.LEDGERNAME 
, A10.VALUE, A11.VALUE, A12.VALUE, A9.VALUE, BUDGET.[Period 1 Budget], budget.[YTD Period 1 Budget] , BUDGET.[Period 2 Budget], budget.[YTD Period 2 Budget] , BUDGET.[Period 3 Budget], budget.[YTD Period 3 Budget] , BUDGET.[Period 4 Budget], budget.[YTD Period 4 Budget] , BUDGET.[Period 5 Budget], budget.[YTD Period 5 Budget] , BUDGET.[Period 6 Budget], budget.[YTD Period 6 Budget] , BUDGET.[Period 7 Budget], budget.[YTD Period 7 Budget] , BUDGET.[Period 8 Budget], budget.[YTD Period 8 Budget] , BUDGET.[Period 9 Budget], budget.[YTD Period 9 Budget] , BUDGET.[Period 10 Budget], budget.[YTD Period 10 Budget] , BUDGET.[Period 11 Budget], budget.[YTD Period 11 Budget] , BUDGET.[Period 12 Budget], budget.[YTD Period 12 Budget] , BUDGET.[Year Budget], LEDGERCODES.CONTROLTYPE, CONTROLCODES.CONTROLNAME  